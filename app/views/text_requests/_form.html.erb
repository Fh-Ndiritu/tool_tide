<%# ------------------------------------------------------------- %>

<%# 1. Non-Form Setup & Layout Wrapper (Main UI structure) %>

<%# ------------------------------------------------------------- %>

<div
  class="
    w-full md:h-full max-w-[1000px] mx-auto flex flex-col md:flex-row
    text-neutral-200
  "
>
  <main
    class="
      lg:flex-1 flex flex-col items-center justify-start pt-4 md:p-8
      md:pb-12 bg-neutral-800
    "
  >
    <% if current_user == text_request.user && text_request.result_image.attached? %>
      <%= link_to "HD Download",  rails_blob_path(text_request.result_image, disposition: :attachment), class: "md:!hidden mb-4 w-auto cute-btn secondary-btn" %>
    <% end %>
    <div class="w-full lg:md:h-full max-w-[700px] flex flex-col">
      <%# ------------------------------------------------------------- %>
      <%# 2. IMAGE DISPLAY (Extracted from the form) %>
      <%# ------------------------------------------------------------- %>
      <div
        class="
          lg:h-[60%] md:min-h-[400px] w-full flex-shrink-0 flex
          items-center justify-center
        "
      >
        <div
          class="
            relative w-full md:h-full rounded-lg overflow-hidden
            shadow-2xl flex items-center
          "
        >
          <% if text_request.original_image.attached? %>
            <div class="absolute inset-0 z-0">
              <%= image_tag text_request.original_image, class: "w-full md:h-full object-cover" %>
              <div class="absolute inset-0 backdrop-blur-xl bg-black/30"></div>
            </div>
            <div id="loader_overlay">
              <% if text_request.in_progress? %>
                <%= render partial: "layouts/shared/loader", locals: { record: text_request, klasses: " group embed absolute w-full h-full z-1" } %>
              <% end %>
            </div>
            <% if text_request.result_image.attached? %>
              <div class="absolute top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 z-20">
                <% favorite = current_user.favorites.find_by(favoritable: text_request) %>
                <%= render 'favorites/favorite_button',
                    favoritable: text_request,
                    favorite: favorite %>
              </div>
            <% end %>
            <div
              class="relative m-auto w-full h-full flex z-10 juxtapose"
              data-startingposition="90"
            >
              <% if text_request.result_image.attached? %>
                <%= image_tag text_request.result_image.variant(:juxtaposed), class: "w-full h-full object-contain", data: {label: "After"} %>
              <% else %>
                <%= image_tag text_request.original_image.variant(:juxtaposed), class: "w-full h-full object-contain", data: {label: "Results will appear here"} %>
              <% end %>
              <%= image_tag text_request.original_image.variant(:juxtaposed), class: "w-full h-full object-contain", data: {label: "Before"} %>
            </div>
          <% else %>
            <div
              class="
                absolute inset-0 w-full md:h-full bg-neutral-700 flex
                items-center justify-center
              "
            >
              <div class="flex flex-col items-center justify-center text-center">
                <p class="relative text-neutral-400">
                  Generate an image in the AI landscaper to get started.
                </p>
                <%= link_to "Generate New Image", new_canva_path, class: "btn cute-btn" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# --- End Image Display --- %>

      <%# ------------------------------------------------------------- %>
      <%# 3. THE FORM (Contains only fields and the Generate button) %>
      <%# ------------------------------------------------------------- %>
      <div class="lg:h-auto w-full flex-shrink-0 flex flex-col">
        <% if text_request.original_image.attached? %>
          <%= form_with(model: text_request, class: "flex flex-col", data: { controller: "prompt-setter", prompt_setter_target: "form" }) do |form| %>
            <div class="my-3 mt-5">
              <div data-controller="dropdown" class="relative w-full">
                <button
                  type="button"
                  data-action="dropdown#toggle"
                  class="w-full p-2 bg-neutral-700/30 rounded-lg border border-neutral-600/50 font-medium text-sm text-secondary hover:text-secondary-light transition-colors list-none flex justify-between items-center select-none focus:outline-none"
                >
                  <span class="pointer-events-none">üí° View Editing Tips</span>
                  <svg class="w-4 h-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div
                  data-dropdown-target="menu"
                  class="hidden absolute left-0 top-full mt-2 w-72 z-50 bg-neutral-900 rounded-xl shadow-xl border border-neutral-700 p-4 space-y-3 text-neutral-300"
                >
                  <div>
                    <strong class="text-white block mb-1">üé® Details Matter</strong>
                    <p>Mention <span class="text-secondary">colors</span>, <span class="text-secondary">features</span>, <span class="text-secondary">materials</span>, <span class="text-secondary">lighting</span> and even <span class="text-secondary">seasons</span>.</p>
                  </div>
                  <div>
                    <strong class="text-white block mb-1">‚úçÔ∏è Use 'Replace'</strong>
                    <p>Clearly state what to remove and add (e.g., "Replace the path with a lawn").</p>
                  </div>
                  <div>
                    <strong class="text-white block mb-1">‚è™ Refining</strong>
                    <p>If a result is wrong, select the previous image from History and try again with a more specific prompt.</p>
                  </div>
                  <div>
                    <strong class="text-white block mb-1">‚ú® Pro Tip</strong>
                    <p>Make one change at a time to save versions and improve accuracy.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="my-3">
              <%= form.label :prompt, "Describe your changes", class: "block mb-2 text-sm font-medium" %>
              <%= form.text_area :prompt, rows: 3, placeholder: "Add spaced out outdoor garden yellow lights along the paths and then convert the image to a night view.", class: "w-full p-3 rounded-lg bg-neutral-700 text-text-light border-4 border-neutral-500 focus:outline-none focus:border-text-primary focus:ring-2 focus:ring-text-primary resize-none transition-colors duration-200 ring-pulse", data: { prompt_setter_target: "prompt", onboarding_target: "prompt", action: "input->prompt-setter#input" } %>
            </div>

            <div
              class="
                flex gap-2 mb-4 overflow-x-auto pb-2 -mx-4 px-4 sm:mx-0
                sm:px-0
              "
            >
              <% quick_prompts_for_buttons.each do |text, value| %>
                <button
                  type="button"
                  data-action="prompt-setter#set"
                  data-prompt-setter-prompt-value="<%= value %>"
                  class="
                    flex-shrink-0 px-3 py-1 text-sm font-medium
                    text-neutral-500 bg-transparent rounded-full
                    hover:bg-neutral-800 hover:text-neutral-300 hover:border-neutral-500
                    transition-colors duration-200
                    border border-neutral-700 whitespace-nowrap
                  "
                >
                  <%= text %>
                </button>
              <% end %>
            </div>

            <%# --- Generate Button (Inside Form) --- %>
            <div class="mt-1 pb-2 flex justify-start">
              <%= form.submit "Generate (#{GOOGLE_IMAGE_COST} credits)",
              class: "max-sm:!w-full cute-btn accent-btn sm:flex-1",
              data: { prompt_setter_target: "submit", onboarding_target: "generate" } if current_user == text_request.user %>
            </div>
          <% end %>
          <%# ------------------------------------------------------------- %>
          <%# 4. EXTERNAL ACTIONS (Download and Like Buttons) %>
          <%# ------------------------------------------------------------- %>
          <div
            class="
              mt-1 pb-2 flex flex-col sm:flex-row
              justify-start items-center space-y-4 sm:space-y-0 sm:space-x-4
              border-t border-neutral-700 pt-4
            "
          >
            <%# HD Download Link %>
            <% if current_user == text_request.user && text_request.result_image.attached? %>
              <%= link_to "HD Download",  rails_blob_path(text_request.result_image, disposition: :attachment), class: "max-md:!hidden max-sm:!w-full cute-btn secondary-btn" %>
            <% end %>

            <%# Favorite Button Block Moved to Image Overlay %>
          </div>
        <% end %>
      </div>
    </div>
  </main>
</div>

<%# --- End Layout Wrapper --- %>

<%# ------------------------------------------------------------- %>

<%# 5. External JS/CSS (Moved to the very bottom) %>

<%# ------------------------------------------------------------- %>

<script
  src="https://cdn.knightlab.com/libs/juxtapose/latest/js/juxtapose.min.js"
></script>

<link
  rel="stylesheet"
  href="https://cdn.knightlab.com/libs/juxtapose/latest/css/juxtapose.css"
>
