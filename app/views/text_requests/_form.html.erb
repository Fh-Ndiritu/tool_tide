<%# ------------------------------------------------------------- %>
<%# 1. Non-Form Setup & Layout Wrapper (Main UI structure) %>
<%# ------------------------------------------------------------- %>
<div
  class="
    w-full md:h-full max-w-[1000px] mx-auto flex flex-col md:flex-row
    overflow-hidden text-text-light
  "
>
  <main
    class="
      lg:flex-1 flex flex-col items-center justify-start pt-4 md:p-8
      md:pb-12 bg-neutral-800
    "
  >

    <% if current_user == text_request.user && text_request.result_image.attached? %>
      <%= link_to "HD Download",  rails_blob_path(text_request.result_image, disposition: :attachment), class: "md:!hidden mb-4 w-auto cute-btn secondary-btn" %>
    <% end %>
    <div class="w-full lg:md:h-full max-w-[700px] flex flex-col">

      <%# ------------------------------------------------------------- %>
      <%# 2. IMAGE DISPLAY (Extracted from the form) %>
      <%# ------------------------------------------------------------- %>
      <div
        class="
          lg:h-[60%] md:min-h-[400px] w-full flex-shrink-0 flex
          items-center justify-center
        "
      >
        <div
          class="
            relative w-full md:h-full rounded-lg overflow-hidden
            shadow-2xl flex items-center
          "
        >
          <% if text_request.original_image.attached? %>
            <div class="absolute inset-0 z-0">
              <%= image_tag text_request.original_image, class: "w-full md:h-full object-cover" %>
              <div class="absolute inset-0 backdrop-blur-xl bg-black/30"></div>
            </div>
            <div id="loader_overlay">
              <% if text_request.in_progress? %>
                <%= render partial: "layouts/shared/loader", locals: { record: text_request, klasses: " group embed absolute w-full h-full z-1" } %>
              <% end %>
            </div>
            <div
              class="relative m-auto !w-[400px] h-auto flex z-10 juxtapose"
              data-startingposition="90"
            >
              <% if text_request.result_image.attached? %>
                <%= image_tag text_request.result_image.variant(:juxtaposed), class: "w-[400px] object-contain", data: {label: "After"} %>
              <% else %>
                <%= image_tag text_request.original_image.variant(:juxtaposed), class: "w-[400px] object-contain", data: {label: "After"} %>
              <% end %>
              <%= image_tag text_request.original_image.variant(:juxtaposed), class: "w-[400px] object-contain", data: {label: "Before"} %>
            </div>
          <% else %>
            <div
              class="
                absolute inset-0 w-full md:h-full bg-neutral-700 flex
                items-center justify-center
              "
            >
              <div class="flex flex-col items-center justify-center text-center">
                <p class="relative text-neutral-500">
                  Generate an image in the AI landscaper to get started.
                </p>
                <%= link_to "Generate New Image", new_canva_path, class: "btn cute-btn" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      <%# --- End Image Display --- %>

      <%# ------------------------------------------------------------- %>
      <%# 3. THE FORM (Contains only fields and the Generate button) %>
      <%# ------------------------------------------------------------- %>
      <div class="lg:h-[40%] w-full flex-shrink-0 flex flex-col">
        <% if text_request.original_image.attached? %>

          <%= form_with(model: text_request, class: "flex flex-col", data: { controller: "prompt-setter", prompt_setter_target: "form" }) do |form| %>

            <div class="my-3 mt-5">
              <%= form.label :prompt, "Image Prompt", class: "block mb-2 text-sm font-medium" %>
              <%= form.text_area :prompt, rows: 3, placeholder: "Add spaced out outdoor garden yellow lights along the paths and then convert the image to a night view.", class: "w-full p-3 rounded-lg bg-neutral-700 text-text-light border-4 border-neutral-500 focus:outline-none focus:border-text-primary focus:ring-2 focus:ring-text-primary resize-none transition-colors duration-200", data: { prompt_setter_target: "prompt" } %>
            </div>
            <div
              class="
                flex gap-2 mb-4 overflow-x-auto pb-2 -mx-4 px-4 sm:mx-0
                sm:px-0
              "
            >
              <% quick_prompts_for_buttons.each do |text, value| %>
                <button
                  type="button"
                  data-action="prompt-setter#setAndClickGenerate"
                  data-prompt-setter-prompt-value="<%= value %>"
                  class="
                    flex-shrink-0 px-3 py-1 text-sm font-medium
                    text-neutral-300 bg-neutral-700 rounded-full
                    hover:bg-neutral-600 transition-colors duration-200
                    border border-neutral-600 whitespace-nowrap
                  "
                >
                  <%= text %>
                </button>
              <% end %>
            </div>

            <%# --- Generate Button (Inside Form) --- %>
            <div
              class="
                mt-1 pb-2 flex justify-start
              "
            >
              <%= form.submit "Generate",
              class: "max-sm:!w-full cute-btn accent-btn sm:flex-1",
              data: { prompt_setter_target: "submit" } if current_user == text_request.user %>
            </div>
          <% end %>

          <%# ------------------------------------------------------------- %>
          <%# 4. EXTERNAL ACTIONS (Download and Like Buttons) %>
          <%# ------------------------------------------------------------- %>
          <div class="
            mt-1 pb-2 flex flex-col sm:flex-row
            justify-start items-center space-y-4 sm:space-y-0 sm:space-x-4
            border-t border-neutral-700 pt-4
          ">

            <%# HD Download Link %>
            <% if current_user == text_request.user && text_request.result_image.attached? %>
              <%= link_to "HD Download",  rails_blob_path(text_request.result_image, disposition: :attachment), class: "max-md:!hidden max-sm:!w-full cute-btn secondary-btn" %>
            <% end %>

            <%# Favorite Button Block %>
            <div class="flex-shrink-0">
              <% favorite = current_user.favorites.find_by(favoritable: text_request) %>
              <%= render 'favorites/favorite_button',
                  favoritable: text_request,
                  favorite: favorite
              %>
            </div>
          </div>
        <% end %>
      </div>

    </div>
  </main>
</div>
<%# --- End Layout Wrapper --- %>

<%# ------------------------------------------------------------- %>
<%# 5. External JS/CSS (Moved to the very bottom) %>
<%# ------------------------------------------------------------- %>
<script
  src="https://cdn.knightlab.com/libs/juxtapose/latest/js/juxtapose.min.js"
></script>

<link
  rel="stylesheet"
  href="https://cdn.knightlab.com/libs/juxtapose/latest/css/juxtapose.css"
>
