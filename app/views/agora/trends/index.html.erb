<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-white flex items-center">
    <span class="p-2 bg-orange-500 rounded-lg mr-3 shadow-lg shadow-orange-500/50">üì°</span>
    Trend Radar
  </h1>
  <%= button_to "üîç Hunt Trends", hunt_agora_trends_path,
      method: :post,
      class: "bg-orange-600 hover:bg-orange-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded transition-colors text-sm",
      form: {
        data: {
          controller: "disable-button",
          action: "submit->disable-button#disable",
          disable_button_duration_value: 10000
        }
      } %>
</div>

<!-- Day Navigation -->
<div class="flex items-center justify-between mb-6 bg-gray-900 border border-gray-800 rounded-lg p-4">
  <div class="flex items-center gap-4">
    <% if @has_newer %>
      <%= link_to agora_trends_path(day: @day_offset - 1), class: "px-4 py-2 bg-gray-700 hover:bg-orange-500 text-white rounded-lg transition-colors flex items-center gap-2" do %>
        ‚Üê Newer
      <% end %>
    <% else %>
      <span class="px-4 py-2 bg-gray-800 text-gray-600 rounded-lg cursor-not-allowed">‚Üê Newer</span>
    <% end %>

    <% if @has_older %>
      <%= link_to agora_trends_path(day: @day_offset + 1), class: "px-4 py-2 bg-gray-700 hover:bg-orange-500 text-white rounded-lg transition-colors flex items-center gap-2" do %>
        Older ‚Üí
      <% end %>
    <% else %>
      <span class="px-4 py-2 bg-gray-800 text-gray-600 rounded-lg cursor-not-allowed">Older ‚Üí</span>
    <% end %>
  </div>

  <div class="text-center">
    <span class="text-xl font-bold text-white"><%= @current_date.strftime("%B %d, %Y") %></span>
    <% if @day_offset == 0 %>
      <span class="ml-2 px-2 py-1 bg-orange-500 text-white text-xs font-bold rounded">TODAY</span>
    <% elsif @day_offset == 1 %>
      <span class="ml-2 px-2 py-1 bg-gray-600 text-white text-xs font-bold rounded">YESTERDAY</span>
    <% else %>
      <span class="ml-2 text-gray-500 text-sm"><%= @day_offset %> days ago</span>
    <% end %>
  </div>

  <div class="text-gray-400 text-sm">
    <span class="font-mono"><%= @trends.count %></span> signals
  </div>
</div>

<div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-8">
  <h2 class="text-gray-400 font-bold uppercase text-xs tracking-wider mb-4">Signal Incoming Volume (Daily)</h2>
  <%
    # Prepare data for Chart.js
    daily_counts = Agora::Trend.all.uniq.group_by { |t| t.created_at.to_date }.transform_values(&:count).sort.to_h
    chart_labels = daily_counts.keys.map { |d| d.strftime("%b %d") }
    chart_values = daily_counts.values
  %>

  <div class="relative h-64 w-full">
    <canvas id="trendVolumeChart"></canvas>
  </div>

  <script>
    (function() {
      const initTrendChart = () => {
        const ctx = document.getElementById('trendVolumeChart');
        if (!ctx) return;

        // Destroy existing chart if it exists to prevent duplicate rendering
        if (window.trendChartInstance) {
          window.trendChartInstance.destroy();
        }

        const labels = <%= chart_labels.to_json.html_safe %>;
        const data = <%= chart_values.to_json.html_safe %>;

        window.trendChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Signals/Day',
              data: data,
              borderColor: '#f97316', // Orange-500
              backgroundColor: 'rgba(249, 115, 22, 0.1)',
              borderWidth: 2,
              pointBackgroundColor: '#f97316',
              pointBorderColor: '#1f2937', // Gray-900
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: '#1f2937',
                titleColor: '#f3f4f6',
                bodyColor: '#d1d5db',
                borderColor: '#374151',
                borderWidth: 1,
                padding: 10,
                displayColors: false
              }
            },
            scales: {
              x: {
                grid: {
                  display: false,
                  drawBorder: false
                },
                ticks: {
                  color: '#9ca3af', // Gray-400
                  font: {
                    family: 'monospace',
                    size: 10
                  }
                }
              },
              y: {
                grid: {
                  color: '#374151', // Gray-700
                  drawBorder: false
                },
                ticks: {
                  color: '#9ca3af',
                  stepSize: 1,
                  font: {
                    family: 'monospace',
                    size: 10
                  }
                },
                beginAtZero: true
              }
            }
          }
        });
      };

      // Initialize on Turbo Load and initial Load
      document.addEventListener("turbo:load", initTrendChart);
      if (document.readyState === "complete" || document.readyState === "interactive") {
        initTrendChart();
      } else {
        document.addEventListener("DOMContentLoaded", initTrendChart);
      }
    })();
  </script>
</div>

<!-- DAILY TRENDS (MOVED UP) -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
  <% @trends.each do |trend| %>
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 hover:border-orange-500 transition-colors duration-300 group">
      <div class="flex justify-between items-start mb-3">
        <span class="text-xs font-mono text-orange-400 bg-orange-900/30 px-2 py-1 rounded">
          <%= trend.created_at.strftime("%b %d") %>
        </span>
        <span class="text-gray-600 text-xs text-right">ID: <%= trend.id %></span>
      </div>

      <h3 class="text-lg font-bold text-gray-200 mb-2 group-hover:text-orange-400 transition-colors">
        <%= trend.content['trend_name'] rescue "Raw Signal" %>
      </h3>

      <p class="text-sm text-gray-400 mb-4 line-clamp-3">
        <%= trend.content['viral_hook_idea'] rescue trend.content %>
      </p>

      <div class="text-xs text-gray-600 pt-3 border-t border-gray-800">
        Intersection: <%= trend.content['intersection_reason'] rescue "N/A" %>
      </div>
    </div>
  <% end %>
</div>

<!-- WEEKLY TRENDS (MOVED DOWN) -->
<% if @weekly_trends.any? %>
  <div class="mb-10 relative">
    <!-- Section Header -->
    <div class="flex items-center gap-3 mb-6">
      <div class="p-2 bg-purple-500/10 rounded-lg border border-purple-500/20 shadow-[0_0_15px_rgba(168,85,247,0.15)]">
        <span class="text-xl">üß†</span>
      </div>
      <div>
        <h2 class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 font-bold uppercase text-xs tracking-[0.2em]">
          Strategic Intelligence
        </h2>
        <h3 class="text-white font-bold text-lg">Weekly Meta-Strategies</h3>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-6">
      <% @weekly_trends.each do |trend| %>
        <!-- Premium Glassmorphic Card -->
        <div class="relative bg-gray-900/60 backdrop-blur-md rounded-2xl border border-white/5 p-8 overflow-hidden group transition-all duration-300 hover:border-purple-500/30 hover:shadow-[0_0_30px_rgba(168,85,247,0.1)] hover:-translate-y-1">

          <!-- Decorative Background Gradients -->
          <div class="absolute -top-20 -right-20 w-60 h-60 bg-purple-600/20 rounded-full blur-[80px] group-hover:bg-purple-600/30 transition-all duration-500"></div>
          <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 opacity-60 group-hover:opacity-100 transition-opacity"></div>

          <div class="relative z-10">
            <!-- Top Section: Header & Meta -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 border-b border-white/5 pb-4">
              <div class="flex items-center gap-3">
                <span class="px-3 py-1 rounded-full bg-purple-500/10 border border-purple-500/20 text-purple-300 text-[10px] font-bold tracking-wider uppercase shadow-[0_0_10px_rgba(168,85,247,0.2)]">
                  Meta-Theme
                </span>
                <span class="text-gray-400 text-xs font-mono flex items-center gap-2">
                  <span class="inline-block w-1.5 h-1.5 rounded-full bg-purple-500"></span>
                  Week <%= trend.created_at.strftime("%W") %>
                </span>
              </div>
              <div class="text-gray-500 text-xs font-mono">
                <%= trend.created_at.beginning_of_week.strftime("%b %d") %> - <%= trend.created_at.end_of_week.strftime("%b %d") %>
              </div>
            </div>

            <!-- Middle Section: Title (Full Width) -->
            <h3 class="text-3xl md:text-4xl font-black text-white mb-8 leading-tight tracking-tight group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-white group-hover:to-purple-200 transition-all">
              <%= trend.content['trend_name'] rescue "Weekly Theme" %>
            </h3>

            <!-- Bottom Section: Stacked Layout -->
            <div class="flex flex-col gap-8">
              <!-- Insight (Full Width) -->
              <div>
                 <p class="text-lg md:text-2xl text-gray-200 leading-relaxed font-light border-l-4 border-purple-500 pl-6 py-2">
                   <%= trend.content['viral_hook_idea'] rescue "" %>
                 </p>
              </div>

              <!-- Strategic Intersection (Full Width Row) -->
              <div class="w-full">
                 <div class="bg-black/40 rounded-xl p-6 border border-white/10 backdrop-blur-sm relative overflow-hidden">
                   <div class="absolute inset-0 bg-gradient-to-r from-purple-500/5 to-transparent"></div>

                   <div class="relative z-10">
                     <div class="flex items-center gap-2 mb-2 text-purple-400 text-xs uppercase tracking-widest font-bold">
                       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                       Strategic Intersection
                     </div>
                     <p class="text-base text-gray-300 italic leading-relaxed">
                       "<%= trend.content['intersection_reason'] rescue "N/A" %>"
                     </p>
                   </div>
                 </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
