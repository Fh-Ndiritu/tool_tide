<h1 class="text-2xl font-bold text-white mb-6 flex items-center">
  <span class="p-2 bg-orange-500 rounded-lg mr-3 shadow-lg shadow-orange-500/50">üì°</span>
  Trend Radar
</h1>

<!-- Day Navigation -->
<div class="flex items-center justify-between mb-6 bg-gray-900 border border-gray-800 rounded-lg p-4">
  <div class="flex items-center gap-4">
    <% if @has_newer %>
      <%= link_to agora_trends_path(day: @day_offset - 1), class: "px-4 py-2 bg-gray-700 hover:bg-orange-500 text-white rounded-lg transition-colors flex items-center gap-2" do %>
        ‚Üê Newer
      <% end %>
    <% else %>
      <span class="px-4 py-2 bg-gray-800 text-gray-600 rounded-lg cursor-not-allowed">‚Üê Newer</span>
    <% end %>

    <% if @has_older %>
      <%= link_to agora_trends_path(day: @day_offset + 1), class: "px-4 py-2 bg-gray-700 hover:bg-orange-500 text-white rounded-lg transition-colors flex items-center gap-2" do %>
        Older ‚Üí
      <% end %>
    <% else %>
      <span class="px-4 py-2 bg-gray-800 text-gray-600 rounded-lg cursor-not-allowed">Older ‚Üí</span>
    <% end %>
  </div>

  <div class="text-center">
    <span class="text-xl font-bold text-white"><%= @current_date.strftime("%B %d, %Y") %></span>
    <% if @day_offset == 0 %>
      <span class="ml-2 px-2 py-1 bg-orange-500 text-white text-xs font-bold rounded">TODAY</span>
    <% elsif @day_offset == 1 %>
      <span class="ml-2 px-2 py-1 bg-gray-600 text-white text-xs font-bold rounded">YESTERDAY</span>
    <% else %>
      <span class="ml-2 text-gray-500 text-sm"><%= @day_offset %> days ago</span>
    <% end %>
  </div>

  <div class="text-gray-400 text-sm">
    <span class="font-mono"><%= @trends.count %></span> signals
  </div>
</div>

<div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-8">
  <h2 class="text-gray-400 font-bold uppercase text-xs tracking-wider mb-4">Signal Incoming Volume (Daily)</h2>
  <%
    # Prepare data for Chart.js
    daily_counts = Agora::Trend.all.uniq.group_by { |t| t.created_at.to_date }.transform_values(&:count).sort.to_h
    chart_labels = daily_counts.keys.map { |d| d.strftime("%b %d") }
    chart_values = daily_counts.values
  %>

  <div class="relative h-64 w-full">
    <canvas id="trendVolumeChart"></canvas>
  </div>

  <script>
    (function() {
      const initTrendChart = () => {
        const ctx = document.getElementById('trendVolumeChart');
        if (!ctx) return;

        // Destroy existing chart if it exists to prevent duplicate rendering
        if (window.trendChartInstance) {
          window.trendChartInstance.destroy();
        }

        const labels = <%= chart_labels.to_json.html_safe %>;
        const data = <%= chart_values.to_json.html_safe %>;

        window.trendChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Signals/Day',
              data: data,
              borderColor: '#f97316', // Orange-500
              backgroundColor: 'rgba(249, 115, 22, 0.1)',
              borderWidth: 2,
              pointBackgroundColor: '#f97316',
              pointBorderColor: '#1f2937', // Gray-900
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: '#1f2937',
                titleColor: '#f3f4f6',
                bodyColor: '#d1d5db',
                borderColor: '#374151',
                borderWidth: 1,
                padding: 10,
                displayColors: false
              }
            },
            scales: {
              x: {
                grid: {
                  display: false,
                  drawBorder: false
                },
                ticks: {
                  color: '#9ca3af', // Gray-400
                  font: {
                    family: 'monospace',
                    size: 10
                  }
                }
              },
              y: {
                grid: {
                  color: '#374151', // Gray-700
                  drawBorder: false
                },
                ticks: {
                  color: '#9ca3af',
                  stepSize: 1,
                  font: {
                    family: 'monospace',
                    size: 10
                  }
                },
                beginAtZero: true
              }
            }
          }
        });
      };

      // Initialize on Turbo Load and initial Load
      document.addEventListener("turbo:load", initTrendChart);
      if (document.readyState === "complete" || document.readyState === "interactive") {
        initTrendChart();
      } else {
        document.addEventListener("DOMContentLoaded", initTrendChart);
      }
    })();
  </script>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  <% @trends.each do |trend| %>
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 hover:border-orange-500 transition-colors duration-300 group">
      <div class="flex justify-between items-start mb-3">
        <span class="text-xs font-mono text-orange-400 bg-orange-900/30 px-2 py-1 rounded">
          <%= trend.created_at.strftime("%b %d") %>
        </span>
        <span class="text-gray-600 text-xs text-right">ID: <%= trend.id %></span>
      </div>

      <h3 class="text-lg font-bold text-gray-200 mb-2 group-hover:text-orange-400 transition-colors">
        <%= trend.content['trend_name'] rescue "Raw Signal" %>
      </h3>

      <p class="text-sm text-gray-400 mb-4 line-clamp-3">
        <%= trend.content['viral_hook_idea'] rescue trend.content %>
      </p>

      <div class="text-xs text-gray-600 pt-3 border-t border-gray-800">
        Intersection: <%= trend.content['intersection_reason'] rescue "N/A" %>
      </div>
    </div>
  <% end %>
</div>
