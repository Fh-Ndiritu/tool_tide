<%# app/views/features/_feature_card.html.erb %>

<%# Local variable: feature %>

<div
  class="
    flex p-4 sm:p-6 border-b border-neutral-200 bg-white shadow-sm rounded-xl
    hover:shadow-xl hover:border-primary/50 transition duration-300 ease-in-out
  "
>
  <%# 1. Polling Column (Left) - Prominent, fixed width on all devices %>
  <div class="mr-4 sm:mr-6 flex-shrink-0">
    <%= render "features/polling_block", feature: feature %>
  </div>

  <%# 2. Feature Content Frame (Main) - The swappable area for content/form %>
  <%= turbo_frame_tag dom_id(feature, :content) do %>
    <div class="flex-1 min-w-0">
      <%# --- Title and Status Block --- %>
      <div class="flex flex-col sm:flex-row justify-between sm:items-start mb-2">
        <h3 class="text-lg sm:text-xl font-semibold text-text-dark leading-snug">
          <%# Title is the primary text. Made it a link to the detail page for consistency. %>
          <%= link_to feature.title, feature_path(feature), class: "hover:text-text-primary transition duration-150" %>
        </h3>

        <%# Status Badge - Aligns nicely on both mobile and desktop %>
        <span
          class="
            ml-0 sm:ml-4 mt-1 sm:mt-0
            px-3 py-1 text-xs font-bold rounded-full
            whitespace-nowrap
            flex-shrink-0
            <%= status_badge_classes(feature.progress) %>
          "
        >
          <%= feature.progress.humanize %>
        </span>
      </div>

      <%# Description Preview %>
      <p class="text-neutral-700 text-sm sm:text-base line-clamp-2 mb-3">
        <%= feature.description.truncate(150) %>
      </p>

      <%# Footer Metadata - Compact and readable on all sizes %>
      <div
        class="
          text-xs sm:text-sm text-neutral-500 flex flex-wrap gap-x-4 gap-y-1
          items-center
        "
      >
        <%# Delivery Date Badge (Visible only if applicable and set) %>
        <% if feature.delivery_trackable? && feature.delivery_date.present? %>
          <span
            class="
              px-2 py-0.5 text-xs font-bold rounded-md bg-accent-secondary
              text-text-dark
            "
          >
            Target: <%= feature.delivery_date.strftime("%b %d") %>
          </span>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# 3. Admin Actions (Right) - HIDDEN ON MOBILE/SMALL SCREENS (sm: breakpoint changed to md:) %>
  <% if current_user&.admin? %>
    <div
      class="
        pl-4 border-l border-neutral-300 hidden md:flex flex-col space-y-2
        min-w-[6rem] items-start
      "
    >
      <%# Edit link targets the content frame for inline editing %>
      <%= link_to "Edit", edit_feature_path(feature),
          data: { turbo_frame: dom_id(feature, :content) },
          class: "text-xs font-medium text-text-primary hover:text-accent-dark hover:underline whitespace-nowrap" %>

      <%# Admin actions to change progress %>
      <% if feature.archived? %>
        <%= button_to "Unarchive", feature_path(feature),
            method: :patch,
            params: { feature: { progress: :planned } },
            class: "text-xs font-medium text-accent hover:text-accent-dark hover:underline cursor-pointer bg-transparent border-none p-0 text-left whitespace-nowrap" %>
      <% else %>
        <%= button_to "Archive", feature_path(feature),
            method: :patch,
            params: { feature: { progress: :archived } },
            data: { turbo_confirm: "Are you sure you want to archive this feature?" },
            class: "text-xs font-medium text-red-500 hover:text-red-700 hover:underline cursor-pointer bg-transparent border-none p-0 text-left whitespace-nowrap" %>
      <% end %>

      <%# Release button %>
      <%= button_to "Release", feature_path(feature),
          method: :patch,
          params: { feature: { progress: :released } },
          data: { turbo_confirm: "Mark this feature as released?" },
          class: "text-xs font-medium text-green-600 hover:text-green-700 hover:underline cursor-pointer bg-transparent border-none p-0 text-left whitespace-nowrap" %>
    </div>
  <% end %>
</div>
