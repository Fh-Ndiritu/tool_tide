<div id="<%= dom_id(sketch_request) %>">
  <div class="min-h-screen bg-gray-900 text-white p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-8">

      <!-- Header -->
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
            Sketch 3D Transformation
          </h1>
          <p class="text-gray-400 mt-1">Status: <span class="text-secondary font-mono"><%= sketch_request.progress.humanize %></span></p>
        </div>
      </div>

      <!-- Error State -->
      <% if sketch_request.failed? %>
        <div class="bg-red-900/50 border border-red-500/50 rounded-xl p-6 text-red-200">
          <h3 class="font-bold text-lg mb-2">Generation Failed</h3>
          <p class="text-sm opacity-80"><%= sketch_request.user_error %></p>
        </div>
      <% end %>

      <!-- PhotoSwipe CSS -->
      <link rel="stylesheet" href="https://unpkg.com/photoswipe@5.4.3/dist/photoswipe.css">

      <!-- Hero CTA Section (Visible when Complete) -->
      <% if sketch_request.complete? && sketch_request.photorealistic_view.attached? %>
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-gray-900 to-gray-800 text-white shadow-2xl transform transition-all hover:scale-[1.01] duration-500 border border-gray-700">
          <div class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-secondary opacity-20 blur-3xl rounded-full pointer-events-none"></div>
          <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-64 h-64 bg-primary opacity-20 blur-3xl rounded-full pointer-events-none"></div>

          <div class="relative z-10 p-8 md:p-10 flex flex-col md:flex-row items-center justify-between gap-8">
            <div class="flex-1 space-y-4">
              <div class="flex items-center gap-3 text-secondary font-bold tracking-wider uppercase text-sm">
                <span class="flex h-2 w-2 rounded-full bg-secondary animate-pulse"></span>
                Next Step
              </div>

              <h4 class="text-2xl md:text-3xl font-bold leading-tight">
                Love the result?
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                  Make it yours.
                </span>
              </h4>

              <p class="text-gray-300 text-lg max-w-xl leading-relaxed">
                Import this photorealistic render into our AI Text Editor to add specific plants, refine textures, or modify any detail with precision.
              </p>
            </div>

            <%= link_to new_text_request_path(signed_blob_id: sketch_request.photorealistic_view.blob.signed_id), class: "cursor-pointer group relative inline-flex items-center gap-3 bg-white text-gray-900 px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-50 transition-all duration-300 hover:shadow-xl hover:-translate-y-1" do %>
              <span>Edit with AI Text</span>
              <%= render(IconComponent.new(classes: "h-6 w-6 text-secondary group-hover:scale-110 transition-transform", name: "pencil")) %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- 3D Views Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8" data-controller="photoswipe">

        <!-- 0. Original Sketch -->
        <div class="space-y-4">
          <div class="relative aspect-[3/4] bg-black rounded-2xl overflow-hidden border border-gray-800 shadow-xl group">
               <% if sketch_request.canva.image.attached? %>
                 <% full_url = rails_blob_path(sketch_request.canva.image) %>
                 <a href="<%= full_url %>"
                    data-pswp-src="<%= full_url %>"
                    data-pswp-width="<%= sketch_request.canva.image.metadata['width'] || 1024 %>"
                    data-pswp-height="<%= sketch_request.canva.image.metadata['height'] || 1024 %>"
                    target="_blank"
                    class="block w-full h-full">
                   <%= image_tag sketch_request.canva.image, loading: "eager", class: "w-full h-full object-cover transition duration-700 group-hover:scale-105", alt: "Original sketch for 3D garden visualization" %>
                 </a>
               <% end %>

               <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded-full border border-white/10">
                 <span class="text-xs font-medium text-gray-300">Original</span>
               </div>
          </div>
          <div class="flex items-center justify-between px-2">
              <h3 class="font-semibold text-lg text-gray-200">Original Sketch</h3>
          </div>
        </div>

        <!-- 1. Clay View -->
        <div class="space-y-4">
          <div class="relative aspect-[3/4] bg-black rounded-2xl overflow-hidden border border-gray-800 shadow-xl group">
               <% if sketch_request.architectural_view.attached? %>
                 <% full_url = rails_blob_path(sketch_request.architectural_view) %>
                 <a href="<%= full_url %>"
                    data-pswp-src="<%= full_url %>"
                    data-pswp-width="<%= sketch_request.architectural_view.metadata['width'] || 1024 %>"
                    data-pswp-height="<%= sketch_request.architectural_view.metadata['height'] || 1024 %>"
                    target="_blank"
                    class="block w-full h-full">
                   <%= image_tag sketch_request.architectural_view, loading: "eager", class: "w-full h-full object-cover transition duration-700 group-hover:scale-105", alt: "AI Architectural view landscape planner" %>
                 </a>
               <% else %>
                 <!-- Loading / Placeholder State -->
                 <div class="absolute inset-0 flex flex-col items-center justify-center space-y-4 p-6 text-center <%= 'animate-pulse bg-gray-800/50' if sketch_request.processing_architectural? %>">
                    <% if sketch_request.processing_architectural? || sketch_request.created? %>
                      <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 animate-spin"></div>
                      <p class="text-gray-400 text-sm font-medium animate-pulse">Generating ArchiCAD View...</p>
                   <% else %>
                     <div class="w-12 h-12 rounded-full bg-gray-800 border border-gray-700"></div>
                     <p class="text-gray-600 font-medium">Waiting to start...</p>
                   <% end %>
                 </div>
               <% end %>

               <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded-full border border-white/10">
                 <span class="text-xs font-medium text-gray-300">Phase 1</span>
               </div>
               <% if sketch_request.architectural_view.attached? %>
                 <div class="absolute bottom-3 right-4 z-20 flex space-x-2">
                   <%= link_to new_text_request_path(signed_blob_id:  sketch_request.architectural_view.blob.signed_id), class: "icon-btn bg-white text-secondary hover:bg-secondary hover:text-white shadow-lg transition-all duration-300 hover:scale-110 hover:shadow-secondary/50 p-3 rounded-full", title: "Refine with AI" do %>
                     <%= render(IconComponent.new(classes: "h-6 w-6", name: "pencil")) %>
                   <% end %>
                 </div>
               <% end %>
          </div>
          <div class="flex items-center justify-between px-2">
              <h3 class="font-semibold text-lg text-gray-200">Clay Rendering</h3>
          </div>
        </div>

        <!-- 2. Architectural View (Now Photorealistic Focus) -->
        <div class="space-y-4">
          <div class="relative aspect-[3/4] bg-black rounded-2xl overflow-hidden border border-gray-700 shadow-2xl shadow-primary/10 group ring-1 ring-white/10">
               <% if sketch_request.photorealistic_view.attached? %>
                 <% full_url = rails_blob_path(sketch_request.photorealistic_view) %>
                 <a href="<%= full_url %>"
                    data-pswp-src="<%= full_url %>"
                    data-pswp-width="<%= sketch_request.photorealistic_view.metadata['width'] || 1024 %>"
                    data-pswp-height="<%= sketch_request.photorealistic_view.metadata['height'] || 1024 %>"
                    target="_blank"
                    class="block w-full h-full">
                   <%= image_tag sketch_request.photorealistic_view, loading: "eager", class: "w-full h-full object-cover transition duration-700 group-hover:scale-105", alt: "Photorealistic 3D garden design rendering" %>
                 </a>
               <% else %>
                 <div class="absolute inset-0 flex flex-col items-center justify-center space-y-4 p-6 text-center <%= 'animate-pulse bg-primary/5' if sketch_request.processing_photorealistic? %>">
                    <% if sketch_request.processing_photorealistic? %>
                      <div class="w-12 h-12 rounded-full border-4 border-primary border-t-transparent animate-spin"></div>
                      <p class="text-primary-300 text-sm font-medium animate-pulse">Rendering 3D Photo Mode...</p>
                    <% elsif sketch_request.progress_before?(:processing_photorealistic) %>
                      <div class="w-12 h-12 rounded-full bg-gray-800 border border-gray-700 opacity-50"></div>
                      <p class="text-gray-600 font-medium">Waiting for ArchiCAD View...</p>
                   <% end %>
                 </div>
               <% end %>

               <div class="absolute top-4 left-4 bg-primary/20 backdrop-blur px-3 py-1 rounded-full border border-primary/30">
                 <span class="text-xs font-bold text-primary-300">Final Result</span>
               </div>
               <% if sketch_request.photorealistic_view.attached? %>
                 <div class="absolute bottom-3 left-4 z-20 flex space-x-2">
                    <%= button_to new_mask_request_sketch_request_path(sketch_request), method: :post, class: "icon-btn bg-black/50 text-white hover:bg-white hover:text-black shadow-lg transition-all duration-300 hover:scale-110 p-3 rounded-full backdrop-blur-sm", title: "Edit with AI Mask Brush" do %>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                          <path fill-rule="evenodd" d="M9.315 7.584C12.195 3.883 16.695 1.5 21.75 1.5a.75.75 0 01.75.75c0 5.056-2.383 9.555-6.084 12.436A6.75 6.75 0 019.75 22.5a.75.75 0 01-.75-.75v-4.131A15.838 15.838 0 016.382 15H2.25a.75.75 0 01-.75-.75 6.75 6.75 0 017.815-6.666zM15 6.75a2.25 2.25 0 100 4.5 2.25 2.25 0 000-4.5z" clip-rule="evenodd" />
                          <path d="M5.26 17.242a.75.75 0 10-.897-1.203 5.243 5.243 0 00-2.05 5.022.75.75 0 00.625.627 5.243 5.243 0 005.022-2.051.75.75 0 10-1.202-.897 3.744 3.744 0 01-3.008 1.51c0-1.23.592-2.323 1.51-3.008z" />
                        </svg>
                    <% end %>
                 </div>
                 <div class="absolute bottom-3 right-4 z-20 flex space-x-2">
                   <%= link_to new_text_request_path(signed_blob_id:  sketch_request.photorealistic_view.blob.signed_id), class: "icon-btn bg-white text-secondary hover:bg-secondary hover:text-white shadow-lg transition-all duration-300 hover:scale-110 hover:shadow-secondary/50 p-3 rounded-full", title: "Refine with AI" do %>
                     <%= render(IconComponent.new(classes: "h-6 w-6", name: "pencil")) %>
                   <% end %>
                 </div>
               <% end %>
          </div>
          <div class="flex items-center justify-between px-2">
              <h3 class="font-semibold text-lg text-white">ArchiCAD Rendering</h3>
          </div>
        </div>

        <!-- 3. Photorealistic View (Now Rotated View) -->
        <div class="space-y-4">
          <div class="relative aspect-[3/4] bg-black rounded-2xl overflow-hidden border border-gray-800 shadow-xl group">
               <% if sketch_request.rotated_view.attached? %>
                 <% full_url = rails_blob_path(sketch_request.rotated_view) %>
                 <a href="<%= full_url %>"
                    data-pswp-src="<%= full_url %>"
                    data-pswp-width="<%= sketch_request.rotated_view.metadata['width'] || 1024 %>"
                    data-pswp-height="<%= sketch_request.rotated_view.metadata['height'] || 1024 %>"
                    target="_blank"
                    class="block w-full h-full">
                   <%= image_tag sketch_request.rotated_view, loading: "eager", class: "w-full h-full object-cover transition duration-700 group-hover:scale-105", alt: "Rotated camera angle backyard design tool" %>
                 </a>


               <% else %>
                 <div class="absolute inset-0 flex flex-col items-center justify-center space-y-4 p-6 text-center <%= 'animate-pulse bg-secondary/5' if sketch_request.processing_rotated? %>">
                    <% if sketch_request.processing_rotated? %>
                      <div class="w-12 h-12 rounded-full border-4 border-secondary border-t-transparent animate-spin"></div>
                      <p class="text-secondary-300 text-sm font-medium animate-pulse">Rendering Recommended Angle...</p>
                    <% elsif sketch_request.progress_before?(:processing_rotated) %>
                      <div class="w-12 h-12 rounded-full bg-gray-800 border border-gray-700 opacity-50"></div>
                      <p class="text-gray-600 font-medium">Waiting for Photo Mode...</p>
                   <% end %>
                 </div>
               <% end %>

               <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded-full border border-white/10">
                 <span class="text-xs font-medium text-purple-300">Additional Angle</span>
               </div>
               <% if sketch_request.rotated_view.attached? %>
                 <div class="absolute bottom-3 right-4 z-20 flex space-x-2">
                   <%= link_to new_text_request_path(signed_blob_id:  sketch_request.rotated_view.blob.signed_id), class: "icon-btn bg-white text-secondary hover:bg-secondary hover:text-white shadow-lg transition-all duration-300 hover:scale-110 hover:shadow-secondary/50 p-3 rounded-full", title: "Refine with AI" do %>
                     <%= render(IconComponent.new(classes: "h-6 w-6", name: "pencil")) %>
                   <% end %>
                 </div>
               <% end %>
          </div>
          <div class="flex items-center justify-between px-2">
              <h3 class="font-semibold text-lg text-white">
                3D Photo
              </h3>
          </div>


        </div>

      </div>

      <!-- Recommendation Footer -->
      <div class="border-t border-gray-800 pt-8 mt-8 text-center space-y-2">
        <p class="text-gray-400">
          You can also use the <span class="text-gray-300 font-medium">mask editor</span> but results may vary.
        </p>
        <p class="text-secondary font-medium flex items-center justify-center gap-2">
          <%= render(IconComponent.new(classes: "h-4 w-4", name: "sparkles")) %>
          We recommend using the text editor
        </p>
      </div>
    </div>
  </div>
</div>
