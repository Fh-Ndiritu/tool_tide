<% is_active = project_layer.design && project_layer.design.active_layer == project_layer %>
<% is_processing = !project_layer.complete? && !project_layer.failed? && !project_layer.original? %>
<% is_viewed = project_layer.viewed? %>

<!-- Thumbnail -->
<div class="relative w-10 h-10 flex-shrink-0 rounded overflow-hidden shadow-sm transition-all duration-200
            <%= is_active ? 'ring-2 ring-blue-500 ring-offset-1 ring-offset-gray-900 opacity-100' : 'ring-1 ring-gray-700 opacity-60 group-hover/layer:opacity-100' %>
            <%= is_processing ? 'opacity-80' : '' %>">
  <% if project_layer.display_image.attached? %>
     <%= image_tag project_layer.display_image.variant(:thumbnail), class: "w-full h-full object-cover" %>
  <% else %>
     <div class="w-full h-full flex items-center justify-center bg-gray-800 text-[8px] text-gray-500">
       <% if is_processing %>
         <div class="w-full h-full animate-pulse bg-gray-700"></div>
       <% else %>
         N/A
       <% end %>
     </div>
  <% end %>

  <% if project_layer.failed? && (project_layer.user_msg.to_s.downcase.include?("credits") || project_layer.error_msg.to_s.downcase.include?("credits")) %>
     <div class="absolute inset-0 bg-black/60 flex items-center justify-center backdrop-blur-[1px] z-10">
        <%= button_to retry_generation_project_design_project_layer_path(project_layer.project, project_layer.design, project_layer), method: :post, form_class: "flex", class: "text-white hover:text-green-400 transition-colors p-1", title: "Retry Generation" do %>
           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
             <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201 2.466l-.312-.311h2.433a.75.75 0 000-1.5H3.989a.75.75 0 00-.75.75v4.242a.75.75 0 001.5 0v-2.43l.31.31a7 7 0 0011.712-3.138.75.75 0 00-1.449-.39zm1.23-3.723a.75.75 0 00.219-.53V2.929a.75.75 0 00-1.5 0V5.36l-.31-.31A7 7 0 003.239 8.188a.75.75 0 101.448.389A5.5 5.5 0 0113.89 6.11l.311.31h-2.432a.75.75 0 000 1.5h4.243a.75.75 0 00.53-.219z" clip-rule="evenodd" />
           </svg>
        <% end %>
     </div>
  <% elsif is_processing %>
     <div class="absolute inset-0 bg-black/40 flex items-center justify-center backdrop-blur-[1px]">
        <svg class="animate-spin h-4 w-4 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
     </div>
  <% end %>
</div>
<% is_sketch_layer = project_layer.intermediate? || project_layer.upscaled? %>

<!-- Info -->
<div class="flex-1 min-w-0 flex flex-col justify-center">
   <div class="flex items-center justify-between">
      <span class="text-xs font-medium truncate transition-colors
                  <%= is_active ? 'text-blue-400' : (is_sketch_layer ? 'text-teal-300 group-hover/layer:text-teal-200' : 'text-gray-200 group-hover/layer:text-white') %>">
        <% if project_layer.original? %>
          Original Upload
        <% elsif is_sketch_layer && project_layer.transformation_type.present? %>
          <%= project_layer.transformation_type.to_s.titleize %>
        <% elsif project_layer.style_preset? && project_layer.preset.present? %>
          <%= project_layer.preset.titleize %>
        <% else %>
          Layer <%= project_layer.layer_number %>
        <% end %>
      </span>
      <% unless is_viewed || is_processing %>
        <span class="flex h-2 w-2 relative">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full <%= is_sketch_layer ? 'bg-teal-400' : 'bg-blue-400' %> opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 <%= is_sketch_layer ? 'bg-teal-500' : 'bg-blue-500' %>"></span>
        </span>
      <% end %>
   </div>

   <div class="flex items-center gap-1.5 text-[10px] leading-none mt-0.5">
      <% if is_processing %>
        <span class="<%= is_sketch_layer ? 'text-teal-400' : 'text-blue-400' %> font-medium animate-pulse group-hover/layer:hidden"><%= project_layer.progress.titleize %>...</span>
        <div class="hidden group-hover/layer:block">
          <%= button_to "Cancel", cancel_generation_project_design_project_layer_path(project_layer.project, project_layer.design, project_layer), method: :post, class: "text-red-500 hover:text-red-400 text-[10px] uppercase font-bold tracking-wide transition-colors", form_class: "inline" %>
        </div>
      <% elsif project_layer.failed? %>
        <span class="text-red-400 font-medium"><%= project_layer.user_msg.presence || "Generation Failed" %></span>
      <% else %>
        <span class="<%= is_sketch_layer ? 'text-teal-400/70' : 'text-gray-400' %>">
          <% if is_sketch_layer %>
            <%= project_layer.generation_type.titleize %>
          <% elsif project_layer.style_preset? %>
            Style Preset
          <% else %>
            <%= project_layer.not_specified? ? 'Uploaded' : project_layer.generation_type.titleize %>
          <% end %>
        </span>
        <span class="<%= is_sketch_layer ? 'text-teal-500/50' : 'text-gray-500' %>">&bull;</span>
        <span class="<%= is_sketch_layer ? 'text-teal-500/50' : 'text-gray-500' %>"><%= time_ago_in_words(project_layer.created_at) %></span>
      <% end %>
   </div>
</div>
