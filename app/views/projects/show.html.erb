<%= turbo_stream_from dom_id(@project) %>
<div class="flex h-screen bg-[#1e1e1e] text-white overflow-hidden"
     data-controller="unified-dashboard"
     data-unified-dashboard-project-id-value="<%= @project.id %>"
     data-unified-dashboard-active-layer-id-value="<%= @initial_layer&.id %>"
     data-unified-dashboard-konva-canvas-outlet="#canvas_wrapper">

  <!-- Left Sidebar: Layers -->
  <div class="w-64 bg-[#252525] border-r border-[#333] flex flex-col">
    <div class="p-4 border-b border-[#333]">
      <h2 class="font-bold text-lg text-gray-200">Layers</h2>
    </div>

    <div class="flex-1 overflow-y-auto p-2 space-y-2" id="sidebar_layers" data-unified-dashboard-target="sidebarLayers">
      <%= render partial: "project_layers/layer", collection: @project.layers.ordered %>
    </div>
  </div>

  <!-- Center: Canvas Area -->
  <div class="flex-1 flex flex-col relative bg-[#1e1e1e]">
    <!-- Top Bar -->
    <div class="h-14 border-b border-[#333] flex items-center justify-between px-4 bg-[#252525]">
      <div class="flex items-center gap-2">
        <%= link_to projects_path, class: "text-gray-400 hover:text-white" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
        <% end %>
        <!-- Editable Title -->
        <div class="group relative flex items-center">
           <input type="text" value="<%= @project.title %>"
                  class="bg-transparent text-white font-medium focus:outline-none focus:border-b border-green-500 w-64 pr-8"
                  data-action="change->unified-dashboard#updateTitle">
           <svg class="w-4 h-4 text-gray-500 absolute right-2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <div class="bg-[#333] rounded px-3 py-1 text-sm flex items-center gap-2">
           <button>-</button>
           <span>100%</span>
           <button>+</button>
        </div>
      </div>
    </div>

    <!-- Canvas Container -->
    <div class="flex-1 relative overflow-hidden flex items-center justify-center bg-[#101010]" id="canvas-scroll-area">

      <!-- Empty State -->
      <%= render "empty_state", project: @project, hidden: @layers.any? %>

      <!-- Konva Wrapper -->
      <%= render "canvas_wrapper", initial_layer: @initial_layer, hidden: @layers.empty? %>


    </div>
  </div>

  <!-- Right Sidebar: Tools -->
  <div class="w-80 bg-[#252525] border-l border-[#333] flex flex-col" data-unified-dashboard-target="toolsPanel">

    <!-- User Balance & Analysis Section -->
    <div class="p-4 space-y-6 flex-1 overflow-y-auto">
      <!-- Credit Balance -->
      <div class="bg-[#111] rounded-lg p-3 border border-[#333] flex items-center justify-between">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" /></svg>
          <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Your Balance</span>
        </div>
        <div class="flex items-baseline gap-1">
          <span class="text-xl font-black text-white"><%= current_user.pro_engine_credits %></span>
          <span class="text-[10px] text-gray-500 font-bold">CR</span>
        </div>
      </div>

      <!-- Tools -->
      <div>
        <label class="text-xs font-bold text-gray-500 uppercase mb-3 block tracking-widest">Editor Tools</label>
        <div class="grid grid-cols-2 gap-2 mb-4">
            <button class="p-3 bg-[#333] hover:bg-[#444] rounded-xl flex flex-col items-center gap-2 transition border-2 border-transparent focus:border-green-500 active:bg-green-500/10 group"
                    data-action="click->konva-canvas#setTool" data-konva-canvas-tool-param="brush">
               <svg class="w-6 h-6 text-gray-400 group-hover:text-green-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
               <span class="text-[10px] font-bold uppercase tracking-tighter">Brush</span>
            </button>
             <button class="p-3 bg-[#333] hover:bg-[#444] rounded-xl flex flex-col items-center gap-2 transition border-2 border-transparent focus:border-green-500 active:bg-red-500/10 group"
                    data-action="click->konva-canvas#setTool" data-konva-canvas-tool-param="eraser">
               <svg class="w-6 h-6 text-gray-400 group-hover:text-red-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
               <span class="text-[10px] font-bold uppercase tracking-tighter">Eraser</span>
            </button>
        </div>

        <!-- History Controls -->
        <div class="flex gap-2 mb-4">
          <button class="flex-1 py-2 bg-[#333] hover:bg-[#444] rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"
                  data-action="click->konva-canvas#undo">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l5 5m-5-5l5-5" /></svg>
            Undo
          </button>
          <button class="flex-1 py-2 bg-[#333] hover:bg-[#444] rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"
                  data-action="click->konva-canvas#redo">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2m18-10l-5 5m5-5l-5-5" /></svg>
            Redo
          </button>
          <button class="px-3 py-2 bg-[#333] hover:bg-red-900/30 hover:text-red-500 rounded-lg text-xs font-bold transition"
                  data-action="click->konva-canvas#clearSelection">
            Clear
          </button>
        </div>

        <!-- Improved Brush Size Slider -->
        <div class="space-y-4 brush-slider mt-4">
          <div class="flex justify-between items-center text-[10px] font-bold text-gray-400 font-black uppercase tracking-widest">
            <span>Thickness</span>
            <span class="text-green-500" data-unified-dashboard-target="brushSizeDisplay">40px</span>
          </div>
          <div class="slider-container relative h-6 flex items-center">
            <input type="range" min="1" max="100" value="40"
                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                   data-action="input->konva-canvas#setBrushSizeFromUI input->unified-dashboard#updateBrushSizeDisplay"
                   data-unified-dashboard-target="brushRange">

            <div class="slider-track absolute w-full h-full bg-[#111] overflow-hidden rounded-sm">
               <div class="slider-fill absolute h-full bg-green-500 opacity-80" data-unified-dashboard-target="sliderFill" style="width: 40%;"></div>
            </div>

            <div class="slider-thumb absolute w-5 h-5 bg-white rounded-full shadow-[0_0_15px_rgba(34,197,94,0.6)] border-2 border-green-500 z-10 -ml-2.5 pointer-events-none transition-shadow"
                 data-unified-dashboard-target="sliderThumb" style="left: 40%;"></div>
          </div>
        </div>
      </div>

      <!-- Generator -->
      <div class="pt-4 border-t border-[#333]">
        <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Generation</label>

        <%= form_with url: generate_project_layers_path(@project), method: :post, local: false, id: "generate_form",
              data: { unified_dashboard_target: "form", action: "submit->unified-dashboard#prepareSubmission" } do |f| %>

          <%= hidden_field_tag :mask_data, "", data: { unified_dashboard_target: "maskInput" } %> <!-- Hidden Mask Input -->

          <!-- Mode Toggle -->
          <div class="flex bg-[#111] p-1 rounded mb-4">
             <button type="button" class="flex-1 py-1 text-xs font-medium rounded text-black bg-white shadow"
                     data-action="click->unified-dashboard#setMode" data-mode="preset" data-unified-dashboard-target="presetModeBtn">
                Preset Style
             </button>
             <button type="button" class="flex-1 py-1 text-xs font-medium rounded text-gray-500 hover:text-gray-300"
                     data-action="click->unified-dashboard#setMode" data-mode="custom" data-unified-dashboard-target="customModeBtn">
                Custom Prompt
             </button>
          </div>

          <!-- Custom Prompt Input -->
          <div class="hidden" data-unified-dashboard-target="customSection">
            <%= f.text_area :prompt, rows: 3,
                  class: "w-full bg-[#111] border border-[#444] rounded p-3 text-sm text-gray-200 focus:border-green-500 focus:outline-none resize-none mb-3",
                  placeholder: "Describe exactly what you want...",
                  data: { action: "input->unified-dashboard#validateGeneration", unified_dashboard_target: "promptInput" } %>
          </div>

          <!-- Preset Section -->
          <div data-unified-dashboard-target="presetSection">
          <div class="mb-4 relative" data-unified-dashboard-target="presetDropdown">
             <label class="text-xs text-gray-400 mb-1 block">Style Preset</label>

             <!-- Hidden Input -->
             <%= f.hidden_field :preset, value: "", data: { unified_dashboard_target: "presetInput" } %>

             <!-- Trigger Button -->
             <button type="button"
                     class="w-full bg-[#111] border border-[#444] rounded p-2 text-sm text-gray-300 flex items-center justify-between hover:border-green-500 transition"
                     data-action="click->unified-dashboard#togglePresetMenu">
                <span data-unified-dashboard-target="presetLabel">No Preset (Realistic)</span>
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
             </button>

             <!-- Dropdown Menu -->
             <div class="hidden absolute bottom-full left-0 w-full mb-2 bg-[#252525] border border-[#444] rounded-lg shadow-xl z-50 max-h-64 overflow-y-auto"
                  data-unified-dashboard-target="presetMenu">

                <button type="button"
                        class="w-full text-left p-2 hover:bg-[#333] flex items-center gap-3 border-b border-[#333] last:border-0"
                        data-action="click->unified-dashboard#selectPreset"
                        data-value=""
                        data-label="No Preset (Realistic)">
                   <div class="w-12 h-12 bg-gray-800 rounded flex items-center justify-center text-xs text-gray-500">None</div>
                   <div>
                      <div class="font-medium text-white text-sm">No Preset</div>
                      <div class="text-[10px] text-gray-500">Realistic output</div>
                   </div>
                </button>

                <% LANDSCAPE_PRESETS.each do |preset, description| %>
                  <button type="button"
                          class="w-full text-left p-2 hover:bg-[#333] flex items-center gap-3 border-b border-[#333] last:border-0"
                          data-action="click->unified-dashboard#selectPreset"
                          data-value="<%= preset %>"
                          data-label="<%= preset.humanize %>">
                     <%= image_tag "presets/#{preset}.png", class: "w-12 h-12 object-cover rounded bg-gray-800" %>
                     <div>
                        <div class="font-medium text-white text-sm"><%= preset.humanize %></div>
                        <div class="text-[10px] text-gray-500"><%= description %></div>
                     </div>
                  </button>
                <% end %>
             </div>
          </div>
          </div>

          <div class="flex items-center justify-between mb-4">
             <label class="text-xs text-gray-400">Variations</label>
             <div class="flex items-center gap-2">
               <%= f.range_field :variations, min: 1, max: 4, value: 1, step: 1,
                      class: "w-20 accent-green-500",
                      data: { action: "input->unified-dashboard#updateVariationCount", unified_dashboard_target: "variationSlider" } %>
               <span class="text-sm font-bold w-4 text-center" data-unified-dashboard-target="variationCount">1</span>
             </div>
          </div>

          <%= f.button "Generate",
                class: "w-full py-3 bg-gray-600 cursor-not-allowed text-black font-bold rounded-lg transition opacity-50",
                data: { unified_dashboard_target: "generateBtn" },
                disabled: true %>
        <% end %>
        <p class="text-[10px] text-gray-500 text-center mt-2">Cost: ~<span id="cost-display" data-unified-dashboard-target="costDisplay">8</span> credits</p>
      </div>

      <!-- Transform Actions -->
      <div class="pt-4 border-t border-[#333]">
         <button class="w-full py-2 bg-[#333] hover:bg-[#444] rounded text-sm text-gray-300 flex items-center justify-center gap-2 transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
            Plant Suggestions
         </button>
          <button class="mt-2 w-full py-2 bg-[#333] hover:bg-[#444] rounded text-sm text-gray-300 flex items-center justify-center gap-2 transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
            Sketch to 3D
         </button>
      </div>

    </div>
  </div>
</div>
