<% content_for :hide_navbar, true %>
<%= turbo_stream_from dom_id(@project) %>
<div class="flex h-screen bg-[#1e1e1e] text-white overflow-hidden"
     data-controller="unified-dashboard"
     data-unified-dashboard-project-id-value="<%= @project.id %>"
     data-unified-dashboard-active-layer-id-value="<%= @initial_layer&.id %>"
     data-unified-dashboard-active-layer-image-url-value="<%= @initial_layer&.image&.attached? ? url_for(@initial_layer.image) : '' %>"
     data-unified-dashboard-suggest-plants-url-value="<%= suggest_plants_project_path(@project) %>"
     data-unified-dashboard-update-location-url-value="<%= update_location_project_path(@project) %>"
     data-unified-dashboard-konva-canvas-outlet="#canvas_wrapper">

  <!-- Left Sidebar: Layers -->
  <div class="w-64 bg-[#252525] border-r border-[#333] flex flex-col">
    <div class="p-4 border-b border-[#333]">
      <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Layers</h2>
    </div>

    <div class="flex-1 overflow-y-auto p-2" id="sidebar_layers" data-unified-dashboard-target="sidebarLayers">
      <%= render partial: "project_layers/layer", collection: @project.layers.where(parent_layer_id: nil).ordered, locals: { depth: 0 } %>
    </div>
  </div>

  <!-- Center: Canvas Area -->
  <div class="flex-1 flex flex-col relative bg-[#1e1e1e]">
    <!-- Top Bar -->
    <div class="h-14 border-b border-[#333] flex items-center justify-between px-4 bg-[#252525]">
      <div class="flex items-center gap-4">
        <%= link_to projects_path, class: "flex items-center gap-2 text-gray-400 hover:text-white transition group" do %>
          <div class="p-1.5 rounded-lg bg-[#333] group-hover:bg-[#444] border border-transparent group-hover:border-[#555] transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
          </div>
          <span class="text-xs font-bold uppercase tracking-wider hidden sm:block">Back</span>
        <% end %>

        <div class="h-6 w-px bg-[#444]"></div>

        <!-- Editable Title -->
        <div class="group relative flex items-center">
           <input type="text" value="<%= @project.title %>"
                  class="bg-transparent text-white font-bold text-sm focus:outline-none focus:border-b border-green-500 w-64 pr-8 placeholder-gray-600 transition"
                  data-action="change->unified-dashboard#updateTitle">
           <svg class="w-3.5 h-3.5 text-gray-600 group-hover:text-gray-400 absolute right-2 pointer-events-none transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
        </div>
      </div>

      <div class="flex items-center gap-4">
         <!-- Download Button -->
        <a href="<%= @initial_layer&.image&.attached? ? url_for(@initial_layer.image) : '#' %>"
           class="flex items-center gap-2 px-3 py-1.5 bg-[#333] hover:bg-[#444] text-gray-300 hover:text-white rounded-lg transition border border-[#444] group <%= 'opacity-50 cursor-not-allowed' unless @initial_layer&.image&.attached? %>"
           data-unified-dashboard-target="downloadBtn"
           download>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
            <span class="text-xs font-bold">Download</span>
        </a>

        <div class="h-6 w-px bg-[#444]"></div>

         <!-- New Project Button -->
        <%= link_to projects_path, data: { turbo_method: :post }, class: "flex items-center gap-2 px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white rounded-lg transition shadow-lg shadow-green-900/20 group" do %>
            <svg class="w-4 h-4 text-green-100 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            <span class="text-xs font-bold">New Project</span>
        <% end %>

        <div class="h-6 w-px bg-[#444]"></div>

        <div class="flex items-center gap-2 bg-[#1a1a1a] rounded-full p-1 border border-[#333]">
           <button class="w-7 h-7 flex items-center justify-center rounded-full bg-[#333] hover:bg-[#444] text-gray-400 hover:text-white transition group"
                   data-action="click->unified-dashboard#zoomOut"
                   title="Zoom Out">
             <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
           </button>

           <span class="text-[10px] font-bold text-gray-500 w-10 text-center select-none" data-unified-dashboard-target="zoomLevel">100%</span>

           <button class="w-7 h-7 flex items-center justify-center rounded-full bg-[#333] hover:bg-[#444] text-gray-400 hover:text-white transition group"
                   data-action="click->unified-dashboard#zoomIn"
                   title="Zoom In">
             <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
           </button>
        </div>
      </div>
    </div>

    <!-- Canvas Container -->
    <div class="flex-1 relative overflow-hidden flex items-center justify-center bg-[#101010]" id="canvas-scroll-area">

      <!-- Empty State -->
      <%= render "empty_state", project: @project, hidden: @layers.any? %>

      <!-- Konva Wrapper -->
      <%= render "canvas_wrapper", initial_layer: @initial_layer, hidden: @layers.empty? %>


    </div>
  </div>

  <!-- Right Sidebar: Tools -->
  <div class="w-80 bg-[#252525] border-l border-[#333] flex flex-col" data-unified-dashboard-target="toolsPanel">

    <!-- Fixed Header Section: Balance & Tabs -->
    <div class="p-4 pb-0 flex-shrink-0 bg-[#252525] z-10">
      <!-- Credit Balance -->
      <div class="bg-[#111] rounded-lg p-3 border border-[#333] flex items-center justify-between mb-6">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" /></svg>
          <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Your Balance</span>
        </div>
        <div class="flex items-baseline gap-1">
          <span class="text-xl font-black text-white"><%= current_user.pro_engine_credits %></span>
          <span class="text-[10px] text-gray-500 font-bold">CR</span>
        </div>
      </div>

      <!-- Tools Tabs -->
      <div class="flex gap-4 border-b border-[#333] mb-4">
          <button class="pb-2 text-sm font-medium text-white border-b-2 border-green-500 transition focus:outline-none"
                  data-action="click->unified-dashboard#switchToolTab" data-tab="brush" data-unified-dashboard-target="brushTab">
              Brush
          </button>
          <button class="pb-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-200 transition focus:outline-none"
                  data-action="click->unified-dashboard#switchToolTab" data-tab="plant" data-unified-dashboard-target="plantTab">
              Plants
          </button>
           <button class="pb-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-200 transition focus:outline-none"
                  data-action="click->unified-dashboard#switchToolTab" data-tab="sketch" data-unified-dashboard-target="sketchTab">
              3D
          </button>
      </div>
    </div>

    <!-- Scrollable Content Section -->
    <div class="flex-1 overflow-hidden relative">
      <div class="absolute inset-0 p-4 pt-0">

      <!-- Tab Content: Brush -->
      <div data-unified-dashboard-target="brushPanel" class="h-full overflow-y-auto custom-scrollbar pr-2">
          <div class="mb-4">
            <p class="text-[10px] text-gray-400 mb-3 leading-relaxed">
              Brush over areas you want to modify, then prompt the AI to change them.
            </p>
          </div>

          <!-- Brush/Eraser Buttons -->
          <div class="grid grid-cols-2 gap-2 mb-4">
            <button class="p-3 bg-[#333] hover:bg-[#444] rounded-xl flex flex-col items-center gap-2 transition border-2 border-transparent focus:outline-none active:bg-green-500/10"
                    data-action="click->unified-dashboard#setTool" data-unified-dashboard-tool-param="brush">
               <%= render IconComponent.new(name: "paint_brush", classes: "w-6 h-6 text-gray-400 transition") %>
               <span class="text-[10px] font-bold uppercase tracking-tighter text-gray-300">Brush</span>
            </button>
             <button class="p-3 bg-[#333] hover:bg-[#444] rounded-xl flex flex-col items-center gap-2 transition border-2 border-transparent focus:outline-none active:bg-red-500/10"
                    data-action="click->unified-dashboard#setTool" data-unified-dashboard-tool-param="eraser">
               <%= render IconComponent.new(name: "eraser", classes: "w-6 h-6 text-gray-400 transition") %>
               <span class="text-[10px] font-bold uppercase tracking-tighter text-gray-300">Eraser</span>
            </button>
        </div>

        <!-- Undo/Redo/Clear -->
        <div class="flex gap-2 mb-4">
          <button class="flex-1 py-2 bg-[#333] hover:bg-[#444] rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 text-gray-300"
                  data-action="click->unified-dashboard#undo">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l5 5m-5-5l5-5" /></svg>
            Undo
          </button>
          <button class="flex-1 py-2 bg-[#333] hover:bg-[#444] rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 text-gray-300"
                  data-action="click->unified-dashboard#redo">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2m18-10l-5 5m5-5l-5-5" /></svg>
            Redo
          </button>
          <button class="px-3 py-2 bg-[#333] hover:bg-red-900/30 hover:text-red-500 rounded-lg text-xs font-bold text-gray-300 transition"
                  data-action="click->unified-dashboard#clearSelection">
            Clear
          </button>
        </div>

        <!-- Improved Brush Size Slider -->
        <div class="space-y-4 brush-slider mt-4">
          <div class="flex justify-between items-center text-[10px] font-bold text-gray-400 font-black uppercase tracking-widest">
            <span>Thickness</span>
            <span class="text-green-500" data-unified-dashboard-target="brushSizeDisplay">40px</span>
          </div>
          <div class="slider-container relative h-6 flex items-center">
            <input type="range" min="1" max="100" value="40"
                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                   data-action="input->unified-dashboard#setBrushSizeFromUI"
                   data-unified-dashboard-target="brushRange">

            <div class="slider-track absolute w-full h-full bg-[#111] overflow-hidden rounded-sm">
               <div class="slider-fill absolute h-full bg-green-500 opacity-80" data-unified-dashboard-target="sliderFill" style="width: 40%;"></div>
            </div>

            <div class="slider-thumb absolute w-5 h-5 bg-white rounded-full shadow-[0_0_15px_rgba(34,197,94,0.6)] border-2 border-green-500 z-10 -ml-2.5 pointer-events-none transition-shadow"
                 data-unified-dashboard-target="sliderThumb" style="left: 40%;"></div>
          </div>
        </div>
        <!-- Generator Section (Inside Brush Panel) -->
        <div class="mt-6 pt-4 border-t border-[#333]">
          <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Generation</label>

          <%= form_with url: generate_project_layers_path(@project), method: :post, local: false, id: "generate_form",
                data: { unified_dashboard_target: "form", action: "submit->unified-dashboard#prepareSubmission" } do |f| %>

            <%= hidden_field_tag :mask_data, "", data: { unified_dashboard_target: "maskInput" } %> <!-- Hidden Mask Input -->
            <%= hidden_field_tag :parent_layer_id, @initial_layer&.id, data: { unified_dashboard_target: "parentLayerInput" } %> <!-- Hidden Parent Layer Input -->

            <!-- Mode Toggle -->
            <div class="flex bg-[#111] p-1 rounded mb-4">
               <button type="button" class="flex-1 py-1 text-xs font-medium rounded text-black bg-white shadow"
                       data-action="click->unified-dashboard#setMode" data-mode="preset" data-unified-dashboard-target="presetModeBtn">
                  Preset Style
               </button>
               <button type="button" class="flex-1 py-1 text-xs font-medium rounded text-gray-500 hover:text-gray-300"
                       data-action="click->unified-dashboard#setMode" data-mode="custom" data-unified-dashboard-target="customModeBtn">
                  Custom Prompt
               </button>
            </div>

            <!-- Custom Prompt Input -->
            <div class="hidden" data-unified-dashboard-target="customSection">
              <%= f.text_area :prompt, rows: 3,
                    class: "w-full bg-[#111] border border-[#444] rounded p-3 text-sm text-gray-200 focus:border-green-500 focus:outline-none resize-none mb-3",
                    placeholder: "Describe exactly what you want...",
                    data: { action: "input->unified-dashboard#validateGeneration", unified_dashboard_target: "promptInput" } %>
            </div>

            <!-- Preset Section -->
            <div data-unified-dashboard-target="presetSection">
            <div class="mb-4 relative" data-unified-dashboard-target="presetDropdown">
               <label class="text-xs text-gray-400 mb-1 block">Style Preset</label>

               <!-- Hidden Input -->
               <%= f.hidden_field :preset, value: "", data: { unified_dashboard_target: "presetInput" } %>

               <!-- Trigger Button -->
               <button type="button"
                       class="w-full bg-[#111] border border-[#444] rounded p-2 text-sm text-gray-300 flex items-center justify-between hover:border-green-500 transition"
                       data-action="click->unified-dashboard#togglePresetMenu">
                  <span data-unified-dashboard-target="presetLabel">No Preset (Realistic)</span>
                  <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
               </button>

               <!-- Dropdown Menu -->
               <div class="hidden absolute bottom-full left-0 w-full mb-2 bg-[#252525] border border-[#444] rounded-lg shadow-xl z-50 max-h-64 overflow-y-auto"
                    data-unified-dashboard-target="presetMenu">

                  <button type="button"
                          class="w-full text-left p-2 hover:bg-[#333] flex items-center gap-3 border-b border-[#333] last:border-0"
                          data-action="click->unified-dashboard#selectPreset"
                          data-value=""
                          data-label="No Preset (Realistic)">
                     <div class="w-12 h-12 bg-gray-800 rounded flex items-center justify-center text-xs text-gray-500">None</div>
                     <div>
                        <div class="font-medium text-white text-sm">No Preset</div>
                        <div class="text-[10px] text-gray-500">Realistic output</div>
                     </div>
                  </button>

                  <% LANDSCAPE_PRESETS.each do |preset, description| %>
                    <button type="button"
                            class="w-full text-left p-2 hover:bg-[#333] flex items-center gap-3 border-b border-[#333] last:border-0"
                            data-action="click->unified-dashboard#selectPreset"
                            data-value="<%= preset %>"
                            data-label="<%= preset.humanize %>">
                       <%= image_tag "presets/#{preset}.png", class: "w-12 h-12 object-cover rounded bg-gray-800" %>
                       <div>
                          <div class="font-medium text-white text-sm"><%= preset.humanize %></div>
                          <div class="text-[10px] text-gray-500"><%= description %></div>
                       </div>
                    </button>
                  <% end %>
               </div>
            </div>
            </div>

            <div class="flex items-center justify-between mb-4">
               <label class="text-xs text-gray-400">Variations</label>
               <div class="flex items-center gap-2">
                 <%= f.range_field :variations, min: 1, max: 4, value: 2, step: 1,
                        class: "w-20 accent-green-500",
                        data: { action: "input->unified-dashboard#updateVariationCount", unified_dashboard_target: "variationSlider" } %>
                 <span class="text-sm font-bold w-4 text-center" data-unified-dashboard-target="variationCount">2</span>
               </div>
            </div>

            <%= f.button "Generate",
                  class: "w-full py-3 bg-gray-600 cursor-not-allowed text-black font-bold rounded-lg transition opacity-50",
                  data: { unified_dashboard_target: "generateBtn" },
                  disabled: true %>
          <% end %>
          <p class="text-[10px] text-gray-500 text-center mt-2">Cost: ~<span id="cost-display" data-unified-dashboard-target="costDisplay">16</span> credits</p>
        </div>
      </div>

      <div data-unified-dashboard-target="plantPanel" class="hidden h-full flex flex-col">
           <div class="mb-4 flex-shrink-0">
              <p class="text-xs text-gray-300 font-medium mb-1">AI Plant Recommendations</p>

              <div class="bg-yellow-900/10 border border-yellow-700/30 p-2 rounded mb-4">
                <p class="text-[10px] text-yellow-500 leading-relaxed">
                  <span class="font-bold">Note:</span> If you have masked an area, recommendations will be based on that specific area.
                </p>
              </div>

              <div class="mb-4">
                <button class="w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg text-white text-sm font-bold shadow-lg transition flex items-center justify-center gap-2"
                        data-action="click->unified-dashboard#requestPlantSuggestions">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Get Local Suggestions
                </button>
              </div>
           </div>

           <!-- Scrollable Plant List -->
           <div class="flex-1 overflow-y-auto -mx-2 px-2 custom-scrollbar" id="plant_results">
               <%= render "projects/plant_list", plants: @plants || [] %>
           </div>
      </div>

       <!-- Tab Content: Sketch to 3D -->
      <div data-unified-dashboard-target="sketchPanel" class="hidden h-full overflow-y-auto custom-scrollbar pr-2">
           <div class="mb-4">
              <p class="text-xs text-gray-300 font-medium mb-1">Sketch to 3D Reality</p>
              <p class="text-[10px] text-gray-400 mb-4 leading-relaxed">
                 Transform your architectural sketches or rough drawings into photorealistic 3D renders.
                 Best used when you have uploaded a sketch file.
              </p>
              <div class="bg-[#333] p-3 rounded-lg border border-[#444] text-center">
                  <svg class="w-8 h-8 text-gray-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                  <p class="text-[10px] text-gray-400">Upload a sketch layer to use this feature.</p>
              </div>
           </div>      </div>
    </div>
  </div>
</div>
