<% content_for :hide_navbar, true %>

<!-- Mobile Blocker (< 580px) -->
<div class="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-8 text-center min-[580px]:hidden">
  <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mb-6 border border-white/10">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
    </svg>
  </div>
  <h2 class="text-xl font-bold text-white mb-2">Desktop or Tablet Required</h2>
  <p class="text-gray-400 mb-8 max-w-xs mx-auto">
    You can use the Brush tools on mobile here.
  </p>
  <%= link_to new_canva_path, class: "px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 transition-all flex items-center gap-2" do %>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
       <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42" />
    </svg>
    Open Brush Tools
  <% end %>
</div>

<div class="fixed inset-0 w-screen h-screen bg-gray-900 text-white overflow-hidden grid grid-cols-[auto_1fr_auto] group/layout group-data-[layout-mode=overlay]/layout:block"
     data-controller="layout projects"
     data-projects-generation-url-value="<%= @active_design ? project_design_project_layers_path(@project, @active_design) : '' %>"
     data-projects-image-cost-value="<%= GOOGLE_IMAGE_COST %>"

  <!-- Left Side: Sidebar + Dock Wrapper -->
  <div class="relative z-30 transition-[width] duration-300 ease-in-out w-[280px] data-[state=collapsed]:w-[60px] group/leftSidebar group-data-[layout-mode=overlay]/layout:absolute group-data-[layout-mode=overlay]/layout:left-0 group-data-[layout-mode=overlay]/layout:h-full group-data-[layout-mode=overlay]/layout:z-50"
       data-layout-target="sidebarLeft"
       data-state="expanded"
       aria-expanded="true">
    <!-- Expanded Content -->
    <div class="w-[280px] bg-gray-900/90 backdrop-blur-xl border-r border-white/10 flex flex-col h-full transition-all duration-300 origin-left overflow-hidden group-data-[state=collapsed]/leftSidebar:w-0 group-data-[state=collapsed]/leftSidebar:opacity-0"
         data-layout-target="leftContent">

      <!-- Sidebar Top: Back & Credits -->
      <div class="p-4 space-y-4 border-b border-white/10">
         <div class="flex items-center justify-between">
             <%= link_to projects_path, class: "flex items-center gap-2 text-gray-400 hover:text-white transition-colors group" do %>
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
               </svg>
               <span class="text-xs font-bold uppercase tracking-wider">Back</span>
             <% end %>

             <!-- Collapse Button -->
             <button class="p-1 text-gray-300 hover:text-white transition-colors" data-action="layout#toggleLeft" title="Toggle Sidebar">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3 3 3m5.25-12h-2.25" />
               </svg>
             </button>
         </div>

         <!-- Sidebar Status Card (Credits + Actions) -->
         <%= render "projects/project_context_actions", project: @project %>
      </div>

      <% if @active_design %>
        <div class="px-4 py-3 border-b border-white/10">
           <div class="font-bold text-xs text-gray-200 leading-snug break-words">
            Editing Design:
            <span class="text-gray-500">
              <%= design_title_for(@active_design).truncate(30) %>
            </span>
            </div>
           <div class="text-[10px] text-gray-200 mt-1 font-medium">Created:
             <span class="text-gray-400"><%= @active_design.created_at.strftime("%Y-%m-%d %H:%M") %></span>
              </div>
        </div>
      <% end %>

      <div class="px-4 py-3 border-b border-white/10 font-semibold text-sm text-gray-200 flex-shrink-0">Layers</div>

      <!-- Fixed Root Layer (Original) -->
      <% if @active_design && (root = @active_design.project_layers.roots.first) %>
        <div class="px-4 pt-4 pb-2 flex-shrink-0">
           <%= render partial: "project_layers/project_layer", object: root, as: :project_layer, locals: { suppress_children: true, children_container_id: "layers_list" } %>
        </div>
      <% end %>

      <div class="flex-1 relative min-h-0">
          <div id="layers_list" class="absolute inset-0 overflow-y-auto px-4 pb-4 space-y-2 premium-scrollbar">
            <% if @active_design %>
              <%= turbo_stream_from @active_design, :layers %>
              <!-- Render children of the root separately since root is fixed above -->
               <% if root %>
                 <%= render partial: "project_layers/project_layer", collection: root.children, as: :project_layer %>
               <% else %>
                 <!-- Fallback if no root found but active design exists -->
                 <%= render partial: "project_layers/project_layer", collection: @active_design.project_layers.roots, as: :project_layer %>
               <% end %>
            <% else %>
              <%= turbo_stream_from @project, :layers %>
              <div id="no_layers_placeholder" class="flex flex-col items-center justify-center h-48 border-2 border-dashed border-gray-700/50 rounded-xl p-4 text-center">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="w-8 h-8 text-gray-600 mb-2">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M6 6.878V6a2.25 2.25 0 0 1 2.25-2.25h7.5A2.25 2.25 0 0 1 18 6v.878m-12 0c.235-.083.487-.128.75-.128h10.5c.263 0 .515.045.75.128m-12 0A2.25 2.25 0 0 0 4.5 9v.878m13.5-3A2.25 2.25 0 0 1 19.5 9v.878m-15 0a2.25 2.25 0 0 0-1.5 2.122v5.25a2.25 2.25 0 0 0 2.25 2.25h13.5a2.25 2.25 0 0 0 2.25-2.25v-5.25a2.25 2.25 0 0 0-1.5-2.122M12 12h.008v.008H12V12Zm0 3h.008v.008H12V15Z" />
                 </svg>
                 <span class="text-[10px] text-gray-500 font-medium uppercase tracking-wider">No Layers</span>
              </div>
            <% end %>
          </div>
      </div>
    </div>

    <!-- Icon Dock (Visible when collapsed) -->
    <div class="w-[60px] bg-gray-900 border-r border-white/10 flex flex-col items-center py-4 absolute inset-y-0 left-0 transition-opacity duration-300 pointer-events-none opacity-0 group-data-[state=collapsed]/leftSidebar:opacity-100 group-data-[state=collapsed]/leftSidebar:pointer-events-auto"
         data-layout-target="leftDock">
         <button class="p-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-all mb-4 relative group"
                 data-action="layout#toggleLeft"
                 title="Layers">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
               <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
             </svg>
            <!-- Pulse indicator if generating -->
            <span class="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse border border-gray-900 hidden"></span>
         </button>
    </div>
  </div>

  <!-- Center: Canvas Workspace -->
  <div class="flex flex-col relative bg-gray-900 transition-all duration-300 min-w-0 overflow-hidden h-full group-data-[layout-mode=overlay]/layout:w-full group-data-[layout-mode=overlay]/layout:h-full"
       data-layout-target="canvasWrapper">

    <!-- Row 1: Header -->
    <div class="h-16 flex-none bg-gray-900/80 backdrop-blur-xl border-b border-white/5 flex items-center justify-between px-4 gap-4 relative z-20 transition-[padding] duration-300 ease-in-out"
         data-layout-target="header">
      <!-- Left: Title & Context -->
      <div class="flex-shrink-0 min-w-0">
        <%= render "projects/project_title", project: @project %>
      </div>

      <!-- Center: Design Tabs -->
      <div class="flex-1 flex justify-center min-w-0 px-8 ">
          <div class="relative group max-w-2xl w-full flex justify-center py-2" data-controller="horizontal-scroll">
             <!-- Left Scroll Button -->
             <button class="absolute -left-3 top-1/2 -translate-y-1/2 z-30 p-1.5 rounded-full bg-white/10 backdrop-blur-md text-white border border-white/20 shadow-lg transition-all opacity-0 duration-300 hover:bg-white/20 hover:scale-110 disabled:opacity-0"
                     data-horizontal-scroll-target="leftArrow"
                     data-action="horizontal-scroll#scrollLeft"
                     aria-label="Scroll Left">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-3.5 h-3.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
             </button>

             <!-- Desktop Tabs Container -->
             <div class=" my-1 hidden sm:flex items-center w-full bg-black/40 rounded-full p-1.5 border border-white/5 shadow-inner overflow-hidden relative group-hover:border-white/10 transition-colors">

                <!-- Left Gradient Mask -->
                <div class="absolute left-0 top-0 bottom-0 w-12 bg-gradient-to-r from-gray-900 via-gray-900/80 to-transparent z-20 pointer-events-none opacity-0 transition-opacity duration-300 rounded-l-full"
                     data-horizontal-scroll-target="leftMask"></div>

                <!-- Inner Scroll Track -->
                <div id="designs_tabs"
                     class="premium-scrollbar p-1 flex items-center gap-2 overflow-x-auto scrollbar-hide w-full px-1 scroll-smooth relative z-10"
                     data-horizontal-scroll-target="container">
                   <% @project.designs.each do |design| %>
                     <%= render "designs/design_tab", design: design, active_design: (@is_new_design_session ? nil : @active_design) %>
                   <% end %>
                </div>

                <!-- Right Gradient Mask -->
                <div class="absolute right-0 top-0 bottom-0 w-12 bg-gradient-to-l from-gray-900 via-gray-900/80 to-transparent z-20 pointer-events-none opacity-0 transition-opacity duration-300 rounded-r-full"
                     data-horizontal-scroll-target="rightMask"></div>
             </div>

             <!-- Right Scroll Button -->
             <button class="absolute -right-3 top-1/2 -translate-y-1/2 z-30 p-1.5 rounded-full bg-white/10 backdrop-blur-md text-white border border-white/20 shadow-lg transition-all opacity-0 duration-300 hover:bg-white/20 hover:scale-110 disabled:opacity-0"
                     data-horizontal-scroll-target="rightArrow"
                     data-action="horizontal-scroll#scrollRight"
                     aria-label="Scroll Right">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-3.5 h-3.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
             </button>

             <!-- Mobile Dropdown -->
             <div class="block sm:hidden w-full max-w-[200px]">
                <select class="w-full bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2"
                        data-action="change->projects#switchDesign">
                  <option value="" disabled <%= 'selected' if @is_new_design_session %>>Select Design</option>
                  <% @project.designs.each do |design| %>
                    <option value="<%= project_path(@project, design_id: design.id) %>" <%= 'selected' if design == @active_design %>>
                      <%= design_title_for(design) %>
                    </option>
                  <% end %>
                </select>
             </div>
          </div>
      </div>

      <!-- Right: Primary Actions -->
      <div class="flex items-center gap-3 flex-shrink-0 min-w-0 justify-end">
        <!-- New Design Upload -->
        <%= form_with url: project_designs_path(@project), method: :post, local: true, class: "flex items-center" do |f| %>
          <label class="flex items-center gap-2 px-3 py-1.5 bg-white text-gray-900 hover:bg-gray-100 text-xs font-bold uppercase tracking-wide rounded-full transition-all shadow-lg shadow-white/5 cursor-pointer border border-white/50 group">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5 text-gray-900 group-hover:scale-110 transition-transform">
               <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
             </svg>
             <span class="hidden xl:inline">New Design</span>
             <%= f.file_field :image, class: "hidden", onchange: "this.form.requestSubmit()" %>
          </label>
        <% end %>
      </div>
    </div>

    <!-- Row 2: Fixed Canvas Workspace -->
    <div class="w-full h-[calc(100vh-8rem)] relative bg-gray-950 overflow-hidden">
       <!-- Absolute Centering Container -->
       <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-6 overflow-hidden">
          <!-- Fixed Dimensions Container (Responsive) -->
          <div class="relative w-full h-full max-w-full max-h-full border border-white/5 bg-gray-900 shadow-2xl rounded-lg overflow-hidden"
               id="canvas-fixed-wrapper">

            <!-- Floating Canvas Toolbar -->
            <% if @active_design&.active_layer&.display_image&.attached? %>
               <%= render "projects/tools/canvas_toolbar" %>
            <% end %>

            <%= turbo_frame_tag "canvas_frame", class: "w-full h-full block" do %>
           <div class="relative w-full h-full flex items-center justify-center" id="canvas-container-<%= @active_design&.active_layer&.id %>" data-turbo-permanent>
           <% if @is_new_design_session %>
              <!-- New Design Minimal Upload State -->
              <div class="max-w-md w-full p-8 text-center space-y-6 bg-gray-800 border border-gray-700 rounded-3xl shadow-2xl shadow-black/50 mx-auto">
                <div class="space-y-3">
                  <div class="w-12 h-12 bg-blue-600/10 rounded-full flex items-center justify-center mx-auto border border-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-blue-400">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                  </div>
                  <h2 class="text-lg font-medium text-white px-4 leading-tight">Upload a related photo of your yard to start designing</h2>
                </div>

                <%= form_with url: project_designs_path(@project), method: :post, local: true do |f| %>
                  <label class="group relative flex flex-col items-center justify-center w-full py-6 border-2 border-dashed border-gray-700 hover:border-blue-500 hover:bg-blue-500/5 rounded-2xl transition-all cursor-pointer">
                    <div class="flex flex-col items-center gap-2">
                      <svg class="w-6 h-6 text-gray-500 group-hover:text-blue-400 transition-colors" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                      </svg>
                      <span class="text-xs font-semibold text-gray-400 group-hover:text-white transition-colors">Choose Image</span>
                    </div>
                    <%= f.file_field :image, class: "hidden", onchange: "this.form.requestSubmit()" %>
                  </label>
                <% end %>
              </div>
           <% elsif @active_design&.active_layer&.display_image&.attached? %>
             <div data-controller="project-canvas"
                  data-project-canvas-target="canvasContainer"
                  data-project-canvas-layer-id-value="<%= @active_design.active_layer.id %>"
                  data-project-canvas-image-url-value="<%= url_for(@active_design.active_layer.display_image) %>"
                  data-project-canvas-display-width-value="<%= @active_design.active_layer.display_image.metadata['width'] || 800 %>"
                  data-project-canvas-display-height-value="<%= @active_design.active_layer.display_image.metadata['height'] || 600 %>"
                  data-project-canvas-brush-size-value="60"
                  class="bg-transparent w-full h-full">
             </div>
           <% else %>
              <div class="text-gray-500">No image loaded</div>
           <% end %>
         </div>
       <% end %>
       </div>
       </div> <!-- End Absolute Centering -->
    </div>

    <!-- Row 3: Footer Controls (Repositioned) -->
    <div class="h-16 flex-none bg-gray-900 border-t border-white/5 flex items-center justify-center relative z-20">
       <div class="flex items-center gap-2 p-1.5 rounded-full">
          <!-- Zoom Controls -->
          <div class="flex items-center gap-1 pr-2 border-r border-white/10">
             <!-- Reset Button -->
             <button class="px-2 text-xs font-bold text-blue-400 hover:text-blue-300 transition-all duration-300 invisible w-0 overflow-hidden data-[visible=true]:w-auto data-[visible=true]:visible"
                     data-action="projects#resetZoom"
                     data-projects-target="resetZoomBtn"
                     title="Reset View">
               Reset
             </button>
             <button class="p-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-full transition-colors" data-action="projects#zoomOut" title="Zoom Out">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
               </svg>
             </button>

             <span class="text-xs font-mono w-10 text-center text-gray-200 select-none" data-projects-target="scaleDisplay">100%</span>

             <button class="p-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-full transition-colors" data-action="projects#zoomIn" title="Zoom In">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
               </svg>
             </button>
          </div>

          <!-- Pan Tool -->
          <button class="p-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-full transition-colors border border-transparent"
                  data-action="projects#setPanTool"
                  title="Pan Tool (Hand)">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
               <path stroke-linecap="round" stroke-linejoin="round" d="M10.05 4.575a1.575 1.575 0 1 0-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 0 1 3.15 0v1.5m-3.15 0 .075 5.925m3.075.75V4.575m0 0a1.575 1.575 0 0 1 3.15 0V15M6.9 7.575a1.575 1.575 0 1 0-3.15 0v8.175a6.75 6.75 0 0 0 6.75 6.75h2.018a5.25 5.25 0 0 0 3.712-1.538l1.732-1.732a5.25 5.25 0 0 0 1.538-3.712l.003-2.024a.668.668 0 0 1 .198-.471 1.575 1.575 0 1 0-2.428-2.228 3.818 3.818 0 0 0-.743 1.055l-.447 1.063a.5.5 0 0 1-.579.29 l-2.41-.482a.5.5 0 0 1-.41-.49V7.575" />
             </svg>
          </button>

          <div class="h-4 w-px bg-white/10 mx-1 hidden lg:block"></div>

          <!-- Focus Toggle -->
          <button class="p-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-full transition-colors hidden lg:block"
                  data-action="layout#toggleFocus"
                  data-layout-target="focusButton"
                  title="Toggle Focus Mode">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
               <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
             </svg>
          </button>

          <!-- Download (Contextual) -->
          <% if @active_design && @active_design.active_layer&.display_image&.attached? %>
            <div class="h-4 w-px bg-white/10 mx-1"></div>
            <%= link_to rails_blob_path(@active_design.active_layer.display_image, disposition: "attachment"),
                class: "p-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-full transition-colors",
                title: "Download Image",
                target: "_blank",
                data: { turbo: false } do %>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
              </svg>
            <% end %>
          <% end %>
       </div>
    </div>
  </div>

  <!-- Right Side: Tool Sidebar + Dock -->
  <div class="relative z-30 transition-[width] duration-300 ease-in-out w-[350px] data-[state=collapsed]:w-[60px] group/rightSidebar group-data-[layout-mode=overlay]/layout:absolute group-data-[layout-mode=overlay]/layout:right-0 group-data-[layout-mode=overlay]/layout:h-full group-data-[layout-mode=overlay]/layout:z-50"
       data-layout-target="sidebarRight"
       data-state="expanded"
       aria-expanded="true">

     <!-- Icon Dock (Visible when collapsed) -->
     <!-- Icon Dock (Visible when collapsed) -->
     <div class="w-[60px] bg-gray-900 border-l border-white/10 flex flex-col items-center py-4 absolute inset-y-0 right-0 transition-opacity duration-300 pointer-events-none opacity-0 group-data-[state=collapsed]/rightSidebar:opacity-100 group-data-[state=collapsed]/rightSidebar:pointer-events-auto"
          data-layout-target="rightDock">

          <button class="p-2.5 rounded-xl hover:bg-white/10 text-gray-400 hover:text-white transition-all mb-2"
                  data-action="click->projects#handleDockClick"
                  data-tab-name="Style Presets"
                  title="Style Presets">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42" />
            </svg>
          </button>

          <button class="p-2.5 rounded-xl hover:bg-white/10 text-gray-400 hover:text-white transition-all mb-2"
                  data-action="click->projects#handleDockClick"
                  data-tab-name="SmartFix"
                  title="SmartFix">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
               <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
             </svg>
          </button>

          <button class="p-2.5 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition-all"
                  data-action="click->projects#handleDockClick"
                  data-tab-name="AutoFix"
                  title="AutoFix">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.703-.127 1.5.168 2.973 1.25 3.723 2.75 2.15 4.302-3.137 7.747-5.426 5.426" />
            </svg>
          </button>
     </div>

    <!-- Expanded Content -->
    <div class="w-[350px] bg-gray-900/90 backdrop-blur-xl border-l border-white/10 flex flex-col h-full transition-all duration-300 origin-right overflow-hidden group-data-[state=collapsed]/rightSidebar:w-0 group-data-[state=collapsed]/rightSidebar:opacity-0"
         data-layout-target="rightContent"
         data-controller="tools"
         data-tools-active-class="text-blue-400 border-blue-400"
         data-tools-inactive-class="text-gray-400 border-transparent hover:text-gray-200">

        <div class="flex items-center justify-between p-2 border-b border-white/10">
           <!-- Collapse Button -->
           <button class="p-1 text-gray-300 hover:text-white transition-colors" data-action="layout#toggleRight" title="Toggle Tools">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m3-3 3 3-3 3m-5.25-12h2.25" />
               </svg>
           </button>
           <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Ai Tools</span>
           <div class="w-5"></div>
        </div>

       <!-- Tabs Header -->
       <div class="flex border-b border-white/10">
          <button class="flex-1 py-3 text-sm font-medium border-b-2 text-blue-400 border-blue-400 transition-colors"
                  data-tools-target="tab"
                  data-action="tools#switch click->projects#updateBrushHint">
            Style Presets
          </button>
           <button class="flex-1 py-3 text-sm font-medium border-b-2 text-gray-300 border-transparent hover:text-gray-200 transition-colors"
                  data-tools-target="tab"
                  data-action="tools#switch click->projects#updateBrushHint">
            SmartFix
          </button>
           <button class="flex-1 py-3 text-sm font-medium border-b-2 text-gray-300 border-transparent hover:text-gray-200 transition-colors"
                  data-tools-target="tab"
                  data-action="tools#switch click->projects#updateBrushHint">
            AutoFix
          </button>
       </div>

       <!-- Content Area -->
       <!-- Content Area -->
       <!-- Content Area -->
       <div class="flex-1 overflow-hidden relative flex flex-col">
           <!-- Tab 1: Style Presets -->
            <div data-tools-target="panel" class="flex flex-col h-full relative">
              <div class="flex-1 overflow-y-auto min-h-0 p-4 pb-24 space-y-6 premium-scrollbar">
                <input type="hidden" name="generation_type" value="style_preset">
               <!-- Landscape Preset Selection -->
               <div>
                  <div class="mb-2 flex flex-col">
                     <label class="text-sm font-medium text-gray-300 mb-2">Choose a Landscape Preset (<%= LANDSCAPE_PRESETS.count %>)</label>
                     <%# We add some text tip on what this does %>

                     <span class="text-xs text-gray-400">Instantly visualize your scene with a different style</span>
                  </div>
                  <div class="relative border border-white/10 rounded-lg bg-gray-900/30">
                     <div class="grid grid-cols-2 gap-2 flex-1 overflow-y-auto p-2 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent transition-all duration-300"
                          data-preset-expansion-target="list">
                       <% LANDSCAPE_PRESETS.each do |preset, description| %>
                         <label class="cursor-pointer relative group">
                           <input type="radio" name="style_preset" value="<%= preset %>" class="peer sr-only"
                                  data-projects-target="stylePresetInput"
                                  data-action="change->projects#validateInputs">
                           <div class="border border-white/10 rounded-lg overflow-hidden bg-white/5 peer-checked:border-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 hover:border-white/20 transition-all">
                          <div class="aspect-video relative overflow-hidden">
                             <%= image_tag "presets/#{preset}.png", class: "w-full h-full object-cover transform transition-transform duration-500 group-hover:scale-120", loading: "lazy" %>
                          </div>
                          <div class="p-2 text-center relative z-10 bg-gray-900/80 backdrop-blur-sm">
                             <div class="text-[10px] font-semibold text-white truncate"><%= preset.titleize %></div>
                          </div>
                       </div>
                         </label>
                       <% end %>
                    </div>
                    <!-- Scroll Hint Gradient -->
                    <div class="absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-gray-900 to-transparent pointer-events-none rounded-b-lg"></div>
                 </div>
              </div>

              </div>

               <!-- Fixed Footer -->
               <div class="absolute bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-white/10 z-20">
                  <p class="text-[12px] text-gray-400 text-center mb-2 leading-tight">AI edits based on the active layer. Please brush on the image if you have specific areas you want to edit.</p>
                  <div class="mb-3"><%= render "projects/tools/variations_controls" %></div>
                  <button class="w-full bg-[#00acc1] hover:bg-[#00838f] disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-white font-bold py-3 rounded-lg shadow-lg shadow-cyan-900/20 transition-all border border-white/10"
                          data-action="click->projects#generate"
                          data-projects-target="generateButton"
                          disabled>
                     Generate Now
                  </button>
               </div>
            </div>

           <!-- Tab 2: SmartFix -->
           <div data-tools-target="panel" class="flex flex-col h-full relative hidden" data-controller="smart-fix-layout">
              <div class="flex-1 overflow-y-auto min-h-0 p-4 pb-24 space-y-6 premium-scrollbar">
                 <input type="hidden" name="generation_type" value="smart_fix">
                 <div data-smart-fix-layout-target="inputs">
                    <div class="space-y-6">
              <!-- AI Assist Description -->
              <p class="text-xs text-gray-300 leading-snug">
                AI Assist converts your text into actionable edits based on the current Layer.
              </p>

              <!-- AI Assist Toggle -->
             <div class="flex items-center justify-between bg-white/5 p-2 rounded-lg border border-white/10">
               <label for="ai-assist-toggle" class="text-xs font-medium text-gray-300 cursor-pointer" data-projects-target="aiAssistLabel">AI Assist On</label>
               <div class="relative inline-block w-9 align-middle select-none transition duration-200 ease-in">
                  <input type="checkbox" name="ai_assist" id="ai-assist-toggle" checked
                         class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-2 appearance-none cursor-pointer checked:right-0 checked:border-blue-600"
                         data-projects-target="aiAssistToggle"
                         data-action="change->projects#toggleAiAssistLabel"/>
                  <label for="ai-assist-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-600 cursor-pointer"></label>
               </div>
             </div>

              <!-- Instructions -->
              <div>
                <label class="block text-xs font-bold uppercase text-gray-400 tracking-wider mb-2">Instructions</label>
                <textarea class="w-full h-64 bg-black/40 border border-white/10 rounded-xl p-4 text-sm text-gray-200 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 resize-none shadow-inner transition-all premium-scrollbar"
                          placeholder="Describe the changes you want to make..."
                          data-projects-target="promptInput"
                          data-action="input->projects#validateInputs"></textarea>
              </div>

                    </div>
                 </div>
              </div>

               <!-- Fixed Footer -->
               <div class="absolute bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-white/10 z-20">
                  <p class="text-[12px] text-gray-400 text-center mb-2 leading-tight">AI edits based on the active layer. Please brush on the image if you have specific areas you want to edit.</p>
                  <div class="mb-3"><%= render "projects/tools/variations_controls" %></div>
                  <button class="w-full bg-[#00acc1] hover:bg-[#00838f] disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-white font-bold py-3 rounded-lg shadow-lg shadow-cyan-900/20 transition-all border border-white/10"
                          data-action="click->projects#generate"
                          data-projects-target="generateButton"
                          disabled>
                     Generate Now
                  </button>
               </div>
            </div>

          <!-- Tab 3: AutoFix -->
          <div data-tools-target="panel" class="h-full relative hidden overflow-hidden">
             <div class="absolute inset-0 overflow-y-auto p-4 space-y-4 premium-scrollbar">
              <input type="hidden" name="generation_type" value="autofix">
              <!-- Description -->
             <p class="text-xs text-gray-400 leading-snug">
               AutoFix detects changes you can make to your yard and generates a variety of prompts you can choose from.
             </p>

             <% if @active_design&.active_layer %>
               <!-- Results Container -->
               <div id="auto_fix_results" data-projects-target="autoFixResults" class="space-y-3">
                 <% auto_fixes = @active_design.active_layer.auto_fixes %>
                 <% if auto_fixes.any? %>
                   <%= render partial: "auto_fixes/auto_fix_item", collection: auto_fixes, as: :auto_fix %>
                 <% else %>
                   <div class="py-4">
                     <%= button_to project_design_project_layer_auto_fixes_path(@project, @active_design, @active_design.active_layer),
                         method: :post,
                         class: "w-full py-4 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl shadow-lg shadow-purple-900/30 transition-all flex items-center justify-center gap-3 group",
                         data: { turbo_stream: true, disable_with: '<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Analyzing...' } do %>
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 group-hover:scale-110 transition-transform">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
                       </svg>
                       Recommend Fixes
                     <% end %>
                   </div>
                 <% end %>
               </div>
             <% else %>
               <div class="text-center py-6 text-gray-500 text-sm">
                 Select a layer to detect fixes.
               </div>
             <% end %>
          </div>
             </div>
           </div>

        </div>
       </div>
    </div>
</div>
