<% if mask_request.failed? %>
  <div class="container mx-auto py-8 text-center">
    <div class="bg-red-50 rounded-3xl p-8 border border-red-100 inline-block">
      <h3 class="text-2xl font-bold text-red-800 mb-2">Generation Failed</h3>
      <p class="text-red-600"><%= mask_request.user_error || "Something went wrong. Please try again." %></p>
       <%= link_to "Try Again", new_canva_mask_request_path(mask_request.canva), class: "mt-4 inline-block px-6 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition" %>
    </div>
  </div>
<% else %>
  <div id="<%= dom_id(mask_request) %>" class="container mx-auto py-8">
    <div class="bg-white/10 backdrop-blur-xl rounded-3xl shadow-xl border border-white/20 overflow-hidden">
      <!-- Header Section -->
      <div
        class="
          px-8 py-8 border-b border-white/20 flex flex-col md:flex-row
          md:items-center justify-between gap-6
        "
      >
        <div>
          <div class="flex items-center gap-3 mb-2">
            <span
              class="
                px-3 py-1 rounded-full bg-green-500/20 text-green-300 text-xs
                font-bold tracking-wide uppercase border border-green-500/30
              "
            >
              <%= mask_request.preset&.humanize %>
            </span>
            <span class="text-neutral-300 text-sm"><%= time_ago_in_words(mask_request.created_at) %> ago</span>
            <% if mask_request.processing? %>
               <span class="animate-pulse text-secondary text-sm font-medium ml-2"> Processing: <%= mask_request.progress.humanize %>...</span>
            <% end %>
          </div>

          <h3 class="text-3xl md:text-4xl font-bold text-white tracking-tight">
            Your Garden Design
          </h3>

          <% if mask_request.user_error.present? %>
            <p class="text-red-500 mt-2 font-medium">
              <%= mask_request.user_error %>
            </p>
          <% end %>
        </div>

        <% favorite = current_user.favorites.find_by(favoritable: mask_request) %>
        <div class="flex-shrink-0">
          <%= render 'favorites/favorite_button', favoritable: mask_request, favorite: favorite %>
        </div>
      </div>

      <div class="p-8 space-y-10">
        <!-- Refine with Prompts - Hero Section -->
        <% if mask_request.main_view.attached? || mask_request.rotated_view.attached? || mask_request.drone_view.attached? %>
        <div
          class="
            relative overflow-hidden rounded-2xl bg-gradient-to-br
            from-gray-900 to-gray-800 text-white shadow-2xl transform
            transition-all hover:scale-[1.01] duration-500
          "
        >
          <div
            class="
              absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-secondary
              opacity-20 blur-3xl rounded-full pointer-events-none
            "
          ></div>

          <div
            class="
              absolute bottom-0 left-0 -mb-10 -ml-10 w-64 h-64 bg-primary
              opacity-20 blur-3xl rounded-full pointer-events-none
            "
          ></div>

          <div
            class="
              relative z-10 p-8 md:p-10 flex flex-col md:flex-row
              items-center justify-between gap-8 min-[580px]:!hidden
            "
          >
            <div class="flex-1 space-y-4">
              <div
                class="
                  flex items-center gap-3 text-secondary font-bold
                  tracking-wider uppercase text-sm
                "
              >
                <span class="flex h-2 w-2 rounded-full bg-secondary animate-pulse"></span>
                Change Style
              </div>

              <h4 class="text-2xl md:text-3xl font-bold leading-tight">
                Not quite right?
                <span
                  class="
                    text-transparent bg-clip-text bg-gradient-to-r
                    from-blue-400 to-purple-400
                  "
                >
                  Change the style.
                </span>
              </h4>

              <p class="text-neutral-300 text-lg max-w-xl leading-relaxed">
                You do not need to draw or mask again, just click select style and experiment with various options.
              </p>
            </div>

            <%= link_to edit_mask_request_path(mask_request, manual: true), data: { onboarding_target: "changeStyle" }, class: "group relative inline-flex items-center gap-2 bg-white/10 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-lg hover:bg-white/20 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border border-white/10" do %>
              <span>Change Style</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                class="
                  w-5 h-5 text-secondary group-hover:scale-110
                  transition-transform
                "
              >
                <path
                  fill-rule="evenodd"
                  d="M2.24 6.8a.75.75 0 001.06-.04l1.95-2.1 1.95 2.1a.75.75 0 101.1-1.02l-2.5-2.7a.75.75 0 00-1.1 0l-2.5 2.7a.75.75 0 00.04 1.06zm6.11 5.5a.75.75 0 001.06-.04l1.95-2.1 1.95 2.1a.75.75 0 101.1-1.02l-2.5-2.7a.75.75 0 00-1.1 0l-2.5 2.7a.75.75 0 00.04 1.06z"
                  clip-rule="evenodd"
                />
                <path
                  d="M9.75 13.25a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-4.5z"
                />
              </svg>
            <% end %>
          </div>

          <!-- Desktop Hero Content (Project Upsell) -->
          <div
            class="
              relative z-10 p-8 md:p-10 flex flex-col md:flex-row
              items-center justify-between gap-8 hidden min-[580px]:!flex
            "
          >
            <div class="flex-1 space-y-4">
              <div
                class="
                  flex items-center gap-3 text-secondary font-bold
                  tracking-wider uppercase text-sm
                "
              >
                <span class="flex h-2 w-2 rounded-full bg-secondary animate-pulse"></span>
                Advanced AI Tools
              </div>

              <h4 class="text-2xl md:text-3xl font-bold leading-tight">
                Take your design further
                <span
                  class="
                    text-transparent bg-clip-text bg-gradient-to-r
                    from-blue-400 to-purple-400
                  "
                >
                  with AI Tools.
                </span>
              </h4>

              <p class="text-neutral-300 text-lg max-w-xl leading-relaxed">
                 Convert to a Project to try presets, automated fixes, and even text edits with AI assist.
              </p>
            </div>

          <div class="hidden min-[580px]:block">
              <% if mask_request.project %>
              <%= link_to project_path(mask_request.project), class: "hidden min-[580px]:inline-flex group relative items-center gap-2 bg-white/10 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-lg hover:bg-white/20 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border border-white/10" do %>
                 <span>Open Project</span>
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-secondary group-hover:scale-110 transition-transform">
                    <path fill-rule="evenodd" d="M2.5 4A1.5 1.5 0 001 5.5V6h18v-.5A1.5 1.5 0 0017.5 4h-15zM19 8.5H1v6A1.5 1.5 0 002.5 16h15a1.5 1.5 0 001.5-1.5v-6zM3 13.25a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zm4.75-.75a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" clip-rule="evenodd" />
                 </svg>
              <% end %>
            <% else %>
               <%= button_to convert_to_project_projects_path(mask_request_id: mask_request.id), method: :post, class: "hidden min-[580px]:inline-flex group relative items-center gap-2 bg-white/10 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-lg hover:bg-white/20 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border border-white/10" do %>
                 <span>Convert to Project</span>
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-secondary group-hover:scale-110 transition-transform">
                    <path fill-rule="evenodd" d="M2.5 4A1.5 1.5 0 001 5.5V6h18v-.5A1.5 1.5 0 0017.5 4h-15zM19 8.5H1v6A1.5 1.5 0 002.5 16h15a1.5 1.5 0 001.5-1.5v-6zM3 13.25a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zm4.75-.75a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" clip-rule="evenodd" />
                 </svg>
               <% end %>
            <% end %>
            </div>

          </div>
        </div>
        <% end %>

        <!-- Preferences Used -->
        <div class="flex flex-wrap gap-3">
          <% if mask_request.add_seating %>
             <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-orange-500/10 text-orange-200 border border-orange-500/20">
               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M3.5 2a.5.5 0 0 0-.5.5v12a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5v-12a.5.5 0 0 0-.5-.5h-9zM4 14V3h1.5v10h-1.5zm2.5-1V4h1.5v9h-1.5zm2.5-1V5h1.5v7h-1.5zm2.5-1V6h1.5v5h-1.5z"/>
               </svg>
               Seating Area added
             </span>
          <% end %>

          <% if mask_request.use_trees %>
             <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-green-500/10 text-green-200 border border-green-500/20">
               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8.416.223a.5.5 0 0 0-.832 0l-3 4.5A.5.5 0 0 0 5 5.5h.098L3.076 8.735A.5.5 0 0 0 3.5 9.5h.191l-1.638 3.276a.5.5 0 0 0 .447.724H7V16h2v-2.5h4.5a.5.5 0 0 0 .447-.724L12.31 9.5h.191a.5.5 0 0 0 .424-.765L10.902 5.5H11a.5.5 0 0 0 .416-.777l-3-4.5z"/>
               </svg>
               Trees added
             </span>
          <% end %>

          <% if mask_request.add_water %>
             <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-cyan-500/10 text-cyan-200 border border-cyan-500/20">
               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M7.21.8C7.69.295 8 0 8 0c.109.363.234.708.371 1.038.812 1.946 2.073 3.35 3.197 4.6C12.878 7.096 14 8.345 14 10a6 6 0 0 1-12 0C2 6.668 5.58 2.517 7.21.8zm.413 1.021A31.25 31.25 0 0 0 5.794 3.99c-.726.95-1.436 2.008-1.96 3.07C3.304 8.133 3 9.138 3 10a5 5 0 0 0 10 0c0-1.201-.796-2.157-2.181-3.7l-.03-.032C9.75 5.11 8.5 3.72 7.623 1.82z"/>
                  <path d="M4.553 7.776c.82-1.641 1.717-2.753 2.093-3.13l.708.708c-.29.29-1.128 1.311-1.907 2.87l-.894-.448z"/>
               </svg>
               Water Features added
             </span>
          <% end %>

          <% if mask_request.use_location %>
             <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-purple-500/10 text-purple-200 border border-purple-500/20">
               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901z"/>
               </svg>
               Localized Plants
             </span>
          <% end %>
        </div>

        <!-- Gallery Grid -->
        <link
          rel="stylesheet"
          href="https://unpkg.com/photoswipe@5.4.3/dist/photoswipe.css"
        >

        <div
          id="gallery-<%= mask_request.id %>"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          data-controller="photoswipe"
        >
          <!-- Option 1: Main View -->
          <% if mask_request.main_view.attached? %>
             <%= render partial: "mask_requests/mask_request_card", locals: { view: mask_request.main_view, title: "Option 1" } %>
          <% else %>
             <!-- Loading State for Option 1 -->
              <div class="relative aspect-[4/3] rounded-2xl overflow-hidden bg-gray-800 border border-white/10 flex flex-col items-center justify-center p-6 text-center">
                 <% if mask_request.processing? %>
                  <div class="w-12 h-12 rounded-full border-4 border-secondary border-t-transparent animate-spin mb-4"></div>
                  <p class="text-white font-medium animate-pulse">Generating Option 1...</p>
                  <p class="text-gray-400 text-sm mt-2"><%= mask_request.progress.humanize %></p>
                 <% else %>
                   <div class="w-12 h-12 rounded-full bg-white/10 mb-4"></div>
                   <p class="text-gray-500 font-medium">Waiting to start...</p>
                 <% end %>
               </div>
          <% end %>

           <!-- Option 2: Rotated View -->
           <% if mask_request.rotated_view.attached? %>
              <%= render partial: "mask_requests/mask_request_card", locals: { view: mask_request.rotated_view, title: "Option 2" } %>
           <% else %>
               <!-- Loading State for Option 2 -->
               <div class="relative aspect-[4/3] rounded-2xl overflow-hidden bg-gray-800 border border-white/10 flex flex-col items-center justify-center p-6 text-center">
                   <% if mask_request.main_view.attached? && mask_request.processing? %>
                       <div class="w-12 h-12 rounded-full border-4 border-primary border-t-transparent animate-spin mb-4"></div>
                       <p class="text-white font-medium animate-pulse">Generating Option 2...</p>
                   <% else %>
                       <div class="w-12 h-12 rounded-full bg-white/5 mb-4"></div>
                       <p class="text-gray-600 font-medium">Waiting for Option 1...</p>
                   <% end %>
               </div>
           <% end %>

            <!-- Option 3: Drone View -->
            <% if mask_request.drone_view.attached? %>
               <%= render partial: "mask_requests/mask_request_card", locals: { view: mask_request.drone_view, title: "Option 3" } %>
            <% else %>
               <!-- Loading State for Option 3 -->
                <div class="relative aspect-[4/3] rounded-2xl overflow-hidden bg-gray-800 border border-white/10 flex flex-col items-center justify-center p-6 text-center">
                    <% if mask_request.rotated_view.attached? && mask_request.processing? %>
                        <div class="w-12 h-12 rounded-full border-4 border-accent border-t-transparent animate-spin mb-4"></div>
                        <p class="text-white font-medium animate-pulse">Generating Option 3...</p>
                    <% else %>
                        <div class="w-12 h-12 rounded-full bg-white/5 mb-4"></div>
                         <p class="text-gray-600 font-medium">Waiting for Option 2...</p>
                    <% end %>
                </div>
            <% end %>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4 justify-center md:justify-start mt-8">
          <%= link_to new_canva_mask_request_path(mask_request.canva), class: "cute-btn btn-secondary flex items-center gap-2", data: { onboarding_target: "brushEdit" } do %>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              class="w-5 h-5"
            >
              <path
                d="M10 3.75a2 2 0 10-4 0 2 2 0 004 0zM17.25 4.5a.75.75 0 00-1.5 0 .75.75 0 001.5 0zM12.75 3.75a.75.75 0 100 1.5.75.75 0 000-1.5zM5 7a1 1 0 011-1h8a1 1 0 011 1v3a1 1 0 01-1 1H6a1 1 0 01-1-1V7zM11.25 15.75a.75.75 0 00-1.5 0V14h1.5v1.75zM14.25 15.75a.75.75 0 00-1.5 0V14h1.5v1.75zM8.25 15.75a.75.75 0 00-1.5 0V14h1.5v1.75zM16 14v1.75a2.25 2.25 0 01-2.25 2.25h-7.5A2.25 2.25 0 014 15.75V14a1 1 0 011-1h10a1 1 0 011 1z"
              />
            </svg>
            Brush Edit
          <% end %>

          <%= link_to new_canva_path, class: "cute-btn btn-primary flex items-center gap-2", data: { onboarding_target: "newDesign" } do %>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              class="w-5 h-5"
            >
              <path
                d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"
              />
            </svg>
            New Design
          <% end %>


           <% if mask_request.main_view.attached? %>
          <%= link_to new_text_request_path(signed_blob_id: mask_request.main_view.blob.signed_id), class: "cute-btn !bg-accent-secondary !text-gray-800 flex items-center gap-2 min-[580px]:!hidden", data: { onboarding_target: "textEdit" } do %>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-5 h-5"
            >
              <path
                fill-rule="evenodd"
                d="M9.315 7.584C12.195 3.883 16.695 1.5 21.75 1.5a.75.75 0 01.75.75c0 5.056-2.383 9.555-6.084 12.436A6.75 6.75 0 019.75 22.5a.75.75 0 01-.75-.75v-4.131A15.838 15.838 0 016.382 15H2.25a.75.75 0 01-.75-.75 6.75 6.75 0 017.815-6.666zM15 6.75a2.25 2.25 0 100 4.5 2.25 2.25 0 000-4.5z"
                clip-rule="evenodd"
              />
              <path
                d="M5.26 17.242a.75.75 0 10-.897-1.203 5.243 5.243 0 00-2.05 5.022.75.75 0 00.625.627 5.243 5.243 0 005.022-2.051.75.75 0 10-1.202-.897 3.744 3.744 0 01-3.008 1.51c0-1.23.592-2.323 1.51-3.008z"
              />
            </svg>
            Smart Fix
          <% end %>

          <% if mask_request.project %>
            <%= link_to project_path(mask_request.project), class: "cute-btn btn-primary !hidden min-[580px]:!inline-flex items-center gap-2 !px-5 !py-2.5 !text-sm !rounded-lg", data: { onboarding_target: "openProject" } do %>
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path fill-rule="evenodd" d="M2.5 4A1.5 1.5 0 001 5.5V6h18v-.5A1.5 1.5 0 0017.5 4h-15zM19 8.5H1v6A1.5 1.5 0 002.5 16h15a1.5 1.5 0 001.5-1.5v-6zM3 13.25a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zm4.75-.75a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" clip-rule="evenodd" />
               </svg>
               Open Project
            <% end %>
          <% else %>
             <%= button_to convert_to_project_projects_path(mask_request_id: mask_request.id), method: :post, class: "cute-btn btn-primary !hidden min-[580px]:!inline-flex items-center gap-2 !px-5 !py-2.5 !text-sm !rounded-lg", data: { onboarding_target: "convertProject" } do %>
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path fill-rule="evenodd" d="M2.5 4A1.5 1.5 0 001 5.5V6h18v-.5A1.5 1.5 0 0017.5 4h-15zM19 8.5H1v6A1.5 1.5 0 002.5 16h15a1.5 1.5 0 001.5-1.5v-6zM3 13.25a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zm4.75-.75a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" clip-rule="evenodd" />
               </svg>
               Convert to Project
             <% end %>
          <% end %>
          <% end %>
        </div>

        <!-- Planting Guide Section -->
        <%= render "mask_requests/planting_guide_section", mask_request: mask_request %>
      </div>
    </div>
  </div>
<% end %>

