<% @canvas_dimensions = capture do
      concat 'data-konva-canvas-display-width-value='
      concat @mask_request.dimensions[:width]
      concat ' data-konva-canvas-display-height-value='
      concat @mask_request.dimensions[:height]
    end %>

<% content_for :title, "New Design" %>

<%= turbo_stream_from @mask_request.canva %>

<div
  data-controller="mask-request"
  data-mask-request-image-url-value="<%= @mask_request.image.attached? ? url_for(@mask_request.drawable_image) : '' %>"
  class="
    relative min-h-screen flex flex-col items-center justify-center p-2
    sm:p-6 lg:p-8 font-sans text-neutral-200 w-full sm:max-w-lg lg:max-w-5xl m-auto
  "
>
  <%= render 'shared/balances' %>
  <div
    class="
      w-full bg-white/10 border border-white/20 backdrop-blur-xl rounded-3xl shadow-2xl
      overflow-hidden p-2 sm:p-8
    "
  >
    <h1
      class="
        text-2xl sm:text-3xl font-bold text-white text-center
        mb-3 md:mb-6 tracking-tight
      "
    >
      Draw areas to modify
    </h1>

    <div
      data-mask-request-target="editorSection"
      class="flex flex-col lg:flex-row lg:gap-8"
    >
      <div
        data-controller="konva-canvas"
        data-konva-canvas-target="canvasContainer"
        data-mask-request-target="konvaCanvasWrapper"
        data-onboarding-target="canvas"
        data-konva-canvas-image-url-value="<%= @mask_request.image.attached? ? url_for(@mask_request.drawable_image) : '' %>"
        <%= @canvas_dimensions %>
        data-konva-canvas-brush-size-value="40"
        class="
          flex-1 bg-black/40 flex items-center justify-center relative
          rounded-xl overflow-hidden shadow-inner border border-white/10
        "
      ></div>
      <div class="lg:w-1/3 flex flex-col space-y-4 p-2 pt-4 md:p-4">
        <div
          class="
            flex w-full flex-row items-center justify-between gap-4 pb-6
            border-b border-white/10
          "
        >
          <div class="flex items-center gap-4">
            <div class="flex flex-col items-center gap-1">
              <button
                data-action="click->mask-request#undoPaintAction"
                data-mask-request-target="undoButton"
                class="
                  p-2 w-12 h-12 flex items-center justify-center
                  bg-secondary rounded-xl text-white border hover:opacity-90
                  transition-colors duration-200 ease-in-out shadow-sm
                "
                title="Undo Last Action"
                data-onboarding-target="control"
              >
                <%= render(IconComponent.new(name: "arrow-counter-clockwise", classes: "h-6 w-6")) %>
              </button>
              <span class="text-xs font-medium text-neutral-400">Undo</span>
            </div>
            <div class="flex flex-col items-center gap-1">
              <button
                data-action="click->mask-request#redoPaintAction"
                data-mask-request-target="redoButton"
                class="
                  p-2 w-12 h-12 flex items-center justify-center
                  bg-secondary rounded-xl text-white border hover:opacity-90
                  transition-colors duration-200 ease-in-out shadow-sm
                "
                title="Redo Last Undo"
                data-onboarding-target="control"
              >
                <%= render(IconComponent.new(name: "arrow-clockwise", classes: "h-6 w-6")) %>
              </button>
              <span class="text-xs font-medium text-neutral-400">Redo</span>
            </div>
          </div>
          <div class="flex flex-col items-center gap-1">
            <button
              data-action="click->mask-request#clearSelection"
              class="
                opacity-80 rounded-xl text-neutral-400 hover:text-white hover:bg-red-500/20 hover:opacity-100
                transition-all duration-200 ease-in-out shadow-sm border border-transparent hover:border-red-500/20
              "
              title="Clear Selection"
              data-onboarding-target="control"
            >
              <%= render(IconComponent.new(name: "x-circle", classes: "h-6 w-6")) %>
            </button>
            <span class="text-xs font-medium text-neutral-400">Clear</span>
          </div>
        </div>

        <div
          data-mask-request-target="brushSizeControl"
          data-onboarding-target="brush"
          class="space-y-4 brush-slider"
        >
          <div class="flex items-center justify-between">
            <label for="brush-size" class="text-xs font-bold uppercase tracking-wider text-neutral-300">Brush Size</label>
            <div
              data-mask-request-target="brushSizeDisplay"
              class="text-sm font-semibold text-[#00acc1]"
            >
              40px
            </div>
          </div>
          <div class="slider-container">
            <!-- The hidden range input controls the value -->
            <input
              type="range"
              id="brush-size"
              min="20"
              max="100"
              value="40"
              data-action="input->mask-request#updateBrushSize"
              data-mask-request-target="brushRange"
            >

            <!-- The visual parts of the slider -->
            <div class="slider-track"></div>

            <div class="slider-fill" data-mask-request-target="fill"></div>

            <div class="slider-thumb" data-mask-request-target="thumb"></div>
          </div>
        </div>



        <div
          id="location_tracker"
          data-controller="location"
          data-location-enable-url-value="<%= update_location_canva_mask_requests_path(@canva) %>"
          class="border-t border-white/10 pt-4 hidden"
        >
          <div class="flex items-center justify-between mb-2">
            <label class="text-xs font-bold uppercase tracking-wider text-neutral-300">Use Local Plants</label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                data-location-target="input"
                data-action="change->location#toggle"
                class="sr-only peer"
                <%= @mask_request.canva.user.latitude.present? ? 'checked' : '' %>
              >
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
            </label>
          </div>

          <div id="user_location_info" class="text-xs text-neutral-300">
             <%= render partial: "mask_requests/location_info", locals: { user: @mask_request.canva.user } %>
          </div>
        </div>

        <%= render "form", mask_request: @mask_request, canva: @canva %>
      </div>
    </div>

    <div
      class="
        mt-6 p-5 bg-white/10 rounded-xl border border-white/20 text-sm
        text-neutral-300 leading-relaxed
      "
    >
      <h3 class="font-bold text-white text-lg mb-3">
        üñåÔ∏è Mastering the Brush Tool
      </h3>

      <p class="mb-3">
        The model modifies only the area
        <strong class="text-white">directly covered by your brush strokes</strong>
        .
      </p>

      <ul class="space-y-2">
        <li class="flex items-start gap-2">
          <span>‚úÖ</span>
          <span>
            <strong>Do this:</strong> Use a thick brush stroke directly over the specific element you want to change.
          </span>
        </li>
        <li class="flex items-start gap-2">
          <span>‚ùå</span>
          <span>
            <strong>Avoid this:</strong>
            Do not simply outline an area; the entire enclosed space will be
            interpreted as the target.
          </span>
        </li>
      </ul>
    </div>
  </div>
  <div id="sketch_overlays">
    <%= render "mask_requests/sketch_overlay", canva: @canva if params[:sketch_detected] == "true" %>
  </div>
</div>
