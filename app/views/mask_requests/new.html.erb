<% @canvas_dimensions = capture do
      concat 'data-konva-canvas-display-width-value='
      concat @mask_request.dimensions[:width]
      concat ' data-konva-canvas-display-height-value='
      concat @mask_request.dimensions[:height]
    end %>

<% content_for :title, "New Design" %>

<%= turbo_stream_from "canva_#{@mask_request.canva.id}" %>

<div
  data-controller="mask-request"
  data-mask-request-image-url-value="<%= @mask_request.image.attached? ? url_for(@mask_request.drawable_image) : '' %>"
  class="
    h-auto bg-neutral-100 flex flex-col items-center justify-center p-2
    sm:p-6 lg:p-8 font-sans text-text-dark max-w-[1100px] m-auto
  "
>
  <%= render 'shared/balances' %>
  <div
    class="
      w-full max-w-full lg:max-w-6xl bg-white rounded-2xl shadow-2xl
      overflow-hidden p-2 sm:p-8 border border-neutral-300
    "
  >
    <h1
      class="
        text-2xl sm:text-3xl font-extrabold text-text-primary text-center
        mb-3 md:mb-8 tracking-wide
      "
    >
      Draw areas to modify
    </h1>
    <div
      data-mask-request-target="editorSection"
      class="flex flex-col lg:flex-row lg:gap-8"
    >
      <div
        data-controller="konva-canvas"
        data-konva-canvas-target="canvasContainer"
        data-mask-request-target="konvaCanvasWrapper"
        data-konva-canvas-image-url-value="<%= @mask_request.image.attached? ? url_for(@mask_request.drawable_image) : '' %>"
        <%= @canvas_dimensions %>
        data-konva-canvas-brush-size-value="40"
        class="
          flex-1 bg-neutral-300 flex items-center justify-center relative
          rounded-xl overflow-hidden shadow-inner
        "
      ></div>
      <div class="lg:w-1/3 flex flex-col space-y-4 p-2 pt-4 md:p-4">
        <div
          class="
            flex w-full flex-row items-center justify-between gap-4 pb-6
            border-b-2 border-neutral-300
          "
        >
          <div class="flex items-center gap-4">
            <div class="flex flex-col items-center gap-1">
              <button
                data-action="click->mask-request#undoPaintAction"
                data-mask-request-target="undoButton"
                class="
                  p-2 w-12 h-12 flex items-center justify-center
                  bg-secondary rounded-xl text-white border hover:opacity-90
                  transition-colors duration-200 ease-in-out shadow-sm
                "
                title="Undo Last Action"
              >
                <%= render(IconComponent.new(name: "arrow-counter-clockwise", classes: "h-6 w-6")) %>
              </button>
              <span class="text-xs font-medium text-neutral-600">Undo</span>
            </div>
            <div class="flex flex-col items-center gap-1">
              <button
                data-action="click->mask-request#redoPaintAction"
                data-mask-request-target="redoButton"
                class="
                  p-2 w-12 h-12 flex items-center justify-center
                  bg-secondary rounded-xl text-white border hover:opacity-90
                  transition-colors duration-200 ease-in-out shadow-sm
                "
                title="Redo Last Undo"
              >
                <%= render(IconComponent.new(name: "arrow-clockwise", classes: "h-6 w-6")) %>
              </button>
              <span class="text-xs font-medium text-neutral-600">Redo</span>
            </div>
          </div>
          <div class="flex flex-col items-center gap-1">
            <button
              data-action="click->mask-request#clearSelection"
              class="
                w-12 h-12 flex items-center justify-center p-2 bg-secondary
                opacity-80 rounded-xl text-text-light hover:opacity-80
                transition-colors duration-200 ease-in-out shadow-sm
              "
              title="Clear Selection"
            >
              <%= render(IconComponent.new(name: "x-circle", classes: "h-6 w-6")) %>
            </button>
            <span class="text-xs font-medium text-neutral-600">Clear</span>
          </div>
        </div>

        <div
          data-mask-request-target="brushSizeControl"
          class="space-y-4 brush-slider"
        >
          <div class="flex items-center justify-between">
            <label for="brush-size" class="text-sm font-medium text-gray-700">Brush Size</label>
            <div
              data-mask-request-target="brushSizeDisplay"
              class="text-sm font-semibold text-indigo-600"
            >
              40px
            </div>
          </div>
          <div class="slider-container">
            <!-- The hidden range input controls the value -->
            <input
              type="range"
              id="brush-size"
              min="20"
              max="100"
              value="40"
              data-action="input->mask-request#updateBrushSize"
              data-mask-request-target="brushRange"
            >

            <!-- The visual parts of the slider -->
            <div class="slider-track"></div>

            <div class="slider-fill" data-mask-request-target="fill"></div>

            <div class="slider-thumb" data-mask-request-target="thumb"></div>
          </div>
        </div>

        <%= render "form", mask_request: @mask_request, canva: @canva %>
      </div>
    </div>
  </div>
</div>
